# Full Stylobot Demo Stack
# =========================
# Complete demonstration environment with:
# - YARP Gateway (bot detection layer)
# - TimescaleDB (detection event storage)
# - Qdrant (vector embeddings)
# - LLamaSharp (local CPU-only LLM for bot name synthesis)
# - Demo website (sample protected application)
# - Caddy (SSL/TLS termination)
#
# Usage:
#   cp .env.example .env  # Create and customize your config
#   docker-compose -f docker-compose.demo.yml up -d
#
# Access:
#   - Demo site: https://demo.stylobot.local (add to /etc/hosts or use localhost)
#   - Dashboard: https://demo.stylobot.local/_stylobot
#   - Gateway Admin: https://demo.stylobot.local/admin/health
#   - Qdrant UI: http://localhost:6333/dashboard
#
# Environment Variables:
#   See .env.example for all configurable options including:
#   - LLM selection (LLamaSharp=CPU-only Qwen, Heuristic=fast local model)
#   - Detection thresholds
#   - Database connections
#   - Model cache path (/models volume)

services:
  # ===========================================
  # Caddy - SSL/TLS termination & reverse proxy
  # ===========================================
  caddy:
    image: caddy:2-alpine
    container_name: stylobot-caddy
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"  # HTTP/3
    volumes:
      - ./demo/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
    depends_on:
      gateway:
        condition: service_healthy
    networks:
      - stylobot-demo
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "caddy", "version"]
      interval: 30s
      timeout: 5s
      retries: 3


  # ===========================================
  # YARP Gateway - Bot Detection Layer
  # ===========================================
  gateway:
    build:
      context: .
      dockerfile: Stylobot.Gateway/Dockerfile
    image: scottgal/stylobot-gateway:latest
    container_name: stylobot-gateway
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      # Enable .NET diagnostics for profiling
      - DOTNET_EnableDiagnostics=1
      - COMPlus_EnableDiagnostics=1
      # Trust all forwarded headers from Caddy (internal Docker network)
      - TRUST_ALL_FORWARDED_PROXIES=true
      # Gateway configuration
      - GATEWAY_DEMO_MODE=true
      - Gateway__DemoMode__PassAllHeaders=true
      - Gateway__DemoMode__UseVerboseLogging=true
      - ADMIN_ALLOW_INSECURE=true
      # Database (TimescaleDB) - uses gateway's direct env var names
      - DB_PROVIDER=Postgres
      - DB_CONNECTION_STRING=Host=timescaledb;Database=stylobot;Username=stylobot;Password=${POSTGRES_PASSWORD:?Set POSTGRES_PASSWORD in .env}
      # Bot detection
      - BotDetection__BotThreshold=0.7
      - BotDetection__BlockDetectedBots=false
      - BotDetection__LogDetailedReasons=true
      - BotDetection__LogAllRequests=true
      # AI detection (uses local CPU-only LLamaSharp plugin)
      - BotDetection__AiDetection__LlamaSharp__ModelPath=Qwen/Qwen2.5-0.5B-Instruct-GGUF/qwen2.5-0.5b-instruct-q4_k_m.gguf
      - BotDetection__AiDetection__LlamaSharp__ContextSize=512
      - BotDetection__AiDetection__LlamaSharp__TimeoutMs=10000
      - BotDetection__AiDetection__LlamaSharp__ModelCacheDir=/models
      # Signature description threshold (trigger LLM when signature gets 50 requests)
      - BotDetection__SignatureDescriptionThreshold=50
      # Response headers (show detection info)
      - BotDetection__ResponseHeaders__Enabled=true
      - BotDetection__ResponseHeaders__IncludeConfidence=true
      - BotDetection__ResponseHeaders__IncludeDetectors=true
      - BotDetection__ResponseHeaders__IncludeProcessingTime=true
      # Legacy API bypass keys (for trusted tooling / dev access)
      - BotDetection__EnableLegacyApiBypassKeys=true
      - BotDetection__ApiBypassKeys__0=${BOTDETECTION_API_BYPASS_KEY:-}
      # Explicit opt-in for benchmark-only full bypass key
      - BotDetection__AllowFullDetectorBypassApiKeys=true
      # ---------------------------------------------------------------
      # Rich API keys — detection policy overlays
      # DEMO ONLY: The SB-* defaults are insecure placeholders for local
      # dev/testing. They are NOT used in production. API keys are for
      # your own automation (CI, k6, monitoring) — not system-to-system.
      # For internet-facing deployments, replace with cryptographically
      # random secrets via .env or a secrets manager.
      # ---------------------------------------------------------------
      # 1. Dashboard monitor — disables behavioral detectors (dashboard polling is repetitive)
      - BotDetection__ApiKeys__${BOTDETECTION_DASHBOARD_API_KEY:-SB-DASHBOARD-MONITOR}__Name=Dashboard Monitor
      - BotDetection__ApiKeys__${BOTDETECTION_DASHBOARD_API_KEY:-SB-DASHBOARD-MONITOR}__DisabledDetectors__0=BehavioralWaveform
      - BotDetection__ApiKeys__${BOTDETECTION_DASHBOARD_API_KEY:-SB-DASHBOARD-MONITOR}__DisabledDetectors__1=Behavioral
      - BotDetection__ApiKeys__${BOTDETECTION_DASHBOARD_API_KEY:-SB-DASHBOARD-MONITOR}__DisabledDetectors__2=AdvancedBehavioral
      - BotDetection__ApiKeys__${BOTDETECTION_DASHBOARD_API_KEY:-SB-DASHBOARD-MONITOR}__AllowedPaths__0=/_stylobot/**
      - BotDetection__ApiKeys__${BOTDETECTION_DASHBOARD_API_KEY:-SB-DASHBOARD-MONITOR}__RateLimitPerMinute=120
      - BotDetection__ApiKeys__${BOTDETECTION_DASHBOARD_API_KEY:-SB-DASHBOARD-MONITOR}__Tags__0=monitoring
      - BotDetection__ApiKeys__${BOTDETECTION_DASHBOARD_API_KEY:-SB-DASHBOARD-MONITOR}__Tags__1=dashboard
      # 2. Full detection — ALL detectors enabled, no exclusions (tests complete pipeline)
      - BotDetection__ApiKeys__${BOTDETECTION_FULL_DETECTION_KEY:-SB-K6-FULL-DETECTION}__Name=k6 Full Detection
      - BotDetection__ApiKeys__${BOTDETECTION_FULL_DETECTION_KEY:-SB-K6-FULL-DETECTION}__ActionPolicyName=logonly
      - BotDetection__ApiKeys__${BOTDETECTION_FULL_DETECTION_KEY:-SB-K6-FULL-DETECTION}__RateLimitPerMinute=600
      - BotDetection__ApiKeys__${BOTDETECTION_FULL_DETECTION_KEY:-SB-K6-FULL-DETECTION}__Tags__0=testing
      - BotDetection__ApiKeys__${BOTDETECTION_FULL_DETECTION_KEY:-SB-K6-FULL-DETECTION}__Tags__1=k6
      # 3. Bypass — disables ALL detectors (latency baseline measurement)
      - BotDetection__ApiKeys__${BOTDETECTION_BYPASS_KEY:-SB-K6-BYPASS}__Name=k6 Bypass Baseline
      - BotDetection__ApiKeys__${BOTDETECTION_BYPASS_KEY:-SB-K6-BYPASS}__DisabledDetectors__0=*
      - BotDetection__ApiKeys__${BOTDETECTION_BYPASS_KEY:-SB-K6-BYPASS}__RateLimitPerMinute=600
      - BotDetection__ApiKeys__${BOTDETECTION_BYPASS_KEY:-SB-K6-BYPASS}__Tags__0=testing
      - BotDetection__ApiKeys__${BOTDETECTION_BYPASS_KEY:-SB-K6-BYPASS}__Tags__1=baseline
      # 4. No-behavioral — disables only behavioral detectors (isolate fingerprint/header detection)
      - BotDetection__ApiKeys__${BOTDETECTION_NO_BEHAVIORAL_KEY:-SB-K6-NO-BEHAVIORAL}__Name=k6 No Behavioral
      - BotDetection__ApiKeys__${BOTDETECTION_NO_BEHAVIORAL_KEY:-SB-K6-NO-BEHAVIORAL}__DisabledDetectors__0=Behavioral
      - BotDetection__ApiKeys__${BOTDETECTION_NO_BEHAVIORAL_KEY:-SB-K6-NO-BEHAVIORAL}__DisabledDetectors__1=AdvancedBehavioral
      - BotDetection__ApiKeys__${BOTDETECTION_NO_BEHAVIORAL_KEY:-SB-K6-NO-BEHAVIORAL}__DisabledDetectors__2=BehavioralWaveform
      - BotDetection__ApiKeys__${BOTDETECTION_NO_BEHAVIORAL_KEY:-SB-K6-NO-BEHAVIORAL}__DisabledDetectors__3=AccountTakeover
      - BotDetection__ApiKeys__${BOTDETECTION_NO_BEHAVIORAL_KEY:-SB-K6-NO-BEHAVIORAL}__ActionPolicyName=logonly
      - BotDetection__ApiKeys__${BOTDETECTION_NO_BEHAVIORAL_KEY:-SB-K6-NO-BEHAVIORAL}__RateLimitPerMinute=600
      - BotDetection__ApiKeys__${BOTDETECTION_NO_BEHAVIORAL_KEY:-SB-K6-NO-BEHAVIORAL}__Tags__0=testing
      - BotDetection__ApiKeys__${BOTDETECTION_NO_BEHAVIORAL_KEY:-SB-K6-NO-BEHAVIORAL}__Tags__1=fingerprint-only
      # Use demo policy with all detectors
      - BotDetection__PathPolicies__/*=demo
      # Upstream routing (to demo website)
      - DEFAULT_UPSTREAM=http://website:8080
    volumes:
      - ./demo/config:/app/config:ro
      - gateway-data:/app/data
      - gateway-logs:/app/logs
      - llm-models:/models  # Persistent cache for LLamaSharp GGUF models
    expose:
      - "8080"
    depends_on:
      timescaledb:
        condition: service_healthy
      website:
        condition: service_healthy
    networks:
      - stylobot-demo
    restart: unless-stopped
    stop_grace_period: 60s
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O /dev/null http://localhost:8080/ || exit 1"]
      interval: 30s
      timeout: 5s
      start_period: 60s
      retries: 3

  # ===========================================
  # Demo Website - Protected Application
  # ===========================================
  website:
    build:
      context: .
      dockerfile: mostlylucid.stylobot.website/Dockerfile
    image: scottgal/stylobot-site:latest
    container_name: stylobot-website
    env_file:
      - .env
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      # Trust all forwarded headers from gateway (internal Docker network)
      - TRUST_ALL_FORWARDED_PROXIES=true
      # Trust upstream detection from YARP gateway (skip re-running detectors)
      - BOTDETECTION_TRUST_UPSTREAM=true
      # Bot Detection Configuration (can be overridden in .env)
      - BOTDETECTION_THRESHOLD=${BOTDETECTION_THRESHOLD:-0.7}
      - BOTDETECTION_BLOCK_BOTS=${BOTDETECTION_BLOCK_BOTS:-false}
      - BOTDETECTION_LOG_DETAILED=${BOTDETECTION_LOG_DETAILED:-true}
      - BOTDETECTION_LOG_ALL_REQUESTS=${BOTDETECTION_LOG_ALL_REQUESTS:-true}
      # LLM Configuration (LlamaSharp=CPU-only Qwen, Heuristic=fast local, Ollama=external service)
      - BOTDETECTION_AI_PROVIDER=${BOTDETECTION_AI_PROVIDER:-LlamaSharp}
      - BotDetection__AiDetection__LlamaSharp__ModelPath=${BOTDETECTION_LLAMASHARP_MODEL_PATH:-Qwen/Qwen2.5-0.5B-Instruct-GGUF/qwen2.5-0.5b-instruct-q4_k_m.gguf}
      - BotDetection__AiDetection__LlamaSharp__ContextSize=${BOTDETECTION_LLAMASHARP_CONTEXT_SIZE:-512}
      - BotDetection__AiDetection__LlamaSharp__TimeoutMs=${BOTDETECTION_LLAMASHARP_TIMEOUT_MS:-10000}
      - BotDetection__AiDetection__LlamaSharp__ModelCacheDir=${BOTDETECTION_LLAMASHARP_MODEL_CACHE_DIR:-/models}
      - BotDetection__SignatureDescriptionThreshold=${BOTDETECTION_SIGNATURE_DESCRIPTION_THRESHOLD:-50}
      # Signature & privacy
      - BOTDETECTION_SIGNATURE_HASH_KEY=${BOTDETECTION_SIGNATURE_HASH_KEY:-}
      - BOTDETECTION_CLIENTSIDE_TOKEN_SECRET=${BOTDETECTION_CLIENTSIDE_TOKEN_SECRET:-}
      # Legacy API bypass keys (for trusted tooling / dev access)
      - BotDetection__EnableLegacyApiBypassKeys=true
      - BotDetection__ApiBypassKeys__0=${BOTDETECTION_API_BYPASS_KEY:-}
      # Rich API keys (same dashboard monitor key as gateway)
      - BotDetection__ApiKeys__${BOTDETECTION_DASHBOARD_API_KEY:-SB-DASHBOARD-MONITOR}__Name=Dashboard Monitor
      - BotDetection__ApiKeys__${BOTDETECTION_DASHBOARD_API_KEY:-SB-DASHBOARD-MONITOR}__DisabledDetectors__0=BehavioralWaveform
      - BotDetection__ApiKeys__${BOTDETECTION_DASHBOARD_API_KEY:-SB-DASHBOARD-MONITOR}__DisabledDetectors__1=Behavioral
      - BotDetection__ApiKeys__${BOTDETECTION_DASHBOARD_API_KEY:-SB-DASHBOARD-MONITOR}__DisabledDetectors__2=AdvancedBehavioral
      - BotDetection__ApiKeys__${BOTDETECTION_DASHBOARD_API_KEY:-SB-DASHBOARD-MONITOR}__AllowedPaths__0=/_stylobot/**
      - BotDetection__ApiKeys__${BOTDETECTION_DASHBOARD_API_KEY:-SB-DASHBOARD-MONITOR}__RateLimitPerMinute=120
      # Dashboard
      - STYLOBOT_DASHBOARD_PUBLIC=true
      - STYLOBOT_DASHBOARD_PATH=${STYLOBOT_DASHBOARD_PATH:-/_stylobot}
      - STYLOBOT_DASHBOARD_MAX_EVENTS=${STYLOBOT_DASHBOARD_MAX_EVENTS:-1000}
      # Database (PostgreSQL/TimescaleDB)
      - DATABASE_PROVIDER=${DATABASE_PROVIDER:-Postgres}
      - DATABASE_CONNECTION_STRING=Host=timescaledb;Database=stylobot;Username=stylobot;Password=${POSTGRES_PASSWORD:?Set POSTGRES_PASSWORD in .env}
      - DATABASE_TIMESCALEDB_ENABLED=${DATABASE_TIMESCALEDB_ENABLED:-true}
      - DATABASE_AUTO_INIT_SCHEMA=${DATABASE_AUTO_INIT_SCHEMA:-true}
      - DATABASE_RETENTION_DAYS=${DATABASE_RETENTION_DAYS:-30}
    volumes:
      - website-data:/app/data
      - website-logs:/app/logs
      - website-config:/app/config
      - llm-models:/models  # Persistent cache for LLamaSharp GGUF models
    expose:
      - "8080"
    depends_on:
      timescaledb:
        condition: service_healthy
    networks:
      - stylobot-demo
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 3s
      start_period: 10s
      retries: 3

  # ===========================================
  # TimescaleDB - Detection Event Storage
  # ===========================================
  timescaledb:
    image: timescale/timescaledb:latest-pg16
    container_name: stylobot-timescaledb
    environment:
      - POSTGRES_DB=stylobot
      - POSTGRES_USER=stylobot
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:?Set POSTGRES_PASSWORD in .env}
      - TIMESCALEDB_TELEMETRY=off
    volumes:
      - timescale-data:/var/lib/postgresql/data
      - ./demo/init-db:/docker-entrypoint-initdb.d:ro
    ports:
      - "127.0.0.1:15432:5432"  # Localhost only - for debugging (15432 to avoid conflict with local PostgreSQL)
    networks:
      - stylobot-demo
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U stylobot -d stylobot"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    command:
      - postgres
      - -c
      - shared_buffers=256MB
      - -c
      - effective_cache_size=1GB
      - -c
      - max_connections=100
      - -c
      - work_mem=16MB

  # ===========================================
  # Qdrant - Vector Database
  # ===========================================
  qdrant:
    image: qdrant/qdrant:latest
    container_name: stylobot-qdrant
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
    volumes:
      - qdrant-data:/qdrant/storage
    ports:
      - "127.0.0.1:6333:6333"  # REST API + Dashboard (localhost only)
      - "127.0.0.1:6334:6334"  # gRPC (localhost only)
    networks:
      - stylobot-demo
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://localhost:6333/"]
      interval: 30s
      timeout: 5s
      retries: 3

  # ===========================================
  # Redis - Session/Cache (optional)
  # ===========================================
  redis:
    image: redis:7-alpine
    container_name: stylobot-redis
    volumes:
      - redis-data:/data
    ports:
      - "127.0.0.1:6379:6379"  # Localhost only
    networks:
      - stylobot-demo
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-changeme}

  # ===========================================
  # Prometheus - Metrics Collection
  # ===========================================
  prometheus:
    image: prom/prometheus:latest
    container_name: stylobot-prometheus
    volumes:
      - ./demo/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    ports:
      - "127.0.0.1:9090:9090"
    networks:
      - stylobot-demo
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://localhost:9090/-/ready"]
      interval: 30s
      timeout: 5s
      retries: 3

  # ===========================================
  # Grafana - Dashboards & Visualization
  # ===========================================
  grafana:
    image: grafana/grafana:latest
    container_name: stylobot-grafana
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-stylobot}
      - GF_SERVER_ROOT_URL=%(protocol)s://%(domain)s/grafana/
      - GF_SERVER_SERVE_FROM_SUB_PATH=true
    volumes:
      - ./demo/grafana/provisioning/datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml:ro
      - ./demo/grafana/provisioning/dashboards.yml:/etc/grafana/provisioning/dashboards/dashboards.yml:ro
      - ./demo/grafana/dashboards:/var/lib/grafana/dashboards:ro
      - grafana-data:/var/lib/grafana
    ports:
      - "127.0.0.1:3000:3000"
    depends_on:
      prometheus:
        condition: service_healthy
    networks:
      - stylobot-demo
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 5s
      retries: 3

# ===========================================
# Networks
# ===========================================
networks:
  stylobot-demo:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

# ===========================================
# Volumes
# ===========================================
volumes:
  # Caddy volumes (SSL certificates, config)
  caddy-data:
    driver: local
  caddy-config:
    driver: local

  # Gateway volumes
  gateway-data:
    driver: local
  gateway-logs:
    driver: local

  # Website volumes
  website-data:
    driver: local
  website-logs:
    driver: local
  website-config:
    driver: local

  # Database volumes
  timescale-data:
    driver: local

  # Vector DB volumes
  qdrant-data:
    driver: local

  # LLM model cache (LLamaSharp GGUF downloads)
  llm-models:
    driver: local

  # Redis cache
  redis-data:
    driver: local

  # Prometheus metrics storage
  prometheus-data:
    driver: local

  # Grafana dashboards and config
  grafana-data:
    driver: local
