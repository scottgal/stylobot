# Full Stylobot Demo Stack
# =========================
# Complete demonstration environment with:
# - YARP Gateway (bot detection layer)
# - TimescaleDB (detection event storage)
# - Qdrant (vector embeddings)
# - Ollama (optional LLM for AI detection)
# - Demo website (sample protected application)
# - Caddy (SSL/TLS termination)
#
# Usage:
#   cp .env.example .env  # Create and customize your config
#   docker-compose -f docker-compose.demo.yml up -d
#
# Access:
#   - Demo site: https://demo.stylobot.local (add to /etc/hosts or use localhost)
#   - Dashboard: https://demo.stylobot.local/_stylobot
#   - Gateway Admin: https://demo.stylobot.local/admin/health
#   - Qdrant UI: http://localhost:6333/dashboard
#   - Ollama: http://localhost:11434
#
# Environment Variables:
#   See .env.example for all configurable options including:
#   - LLM endpoints (Ollama, OpenAI, Anthropic)
#   - Detection thresholds
#   - Database connections
#   - Volume paths

services:
  # ===========================================
  # Caddy - SSL/TLS termination & reverse proxy
  # ===========================================
  caddy:
    image: caddy:2-alpine
    container_name: stylobot-caddy
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"  # HTTP/3
    volumes:
      - ./demo/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
    depends_on:
      gateway:
        condition: service_healthy
    networks:
      - stylobot-demo
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "caddy", "version"]
      interval: 30s
      timeout: 5s
      retries: 3

  # ===========================================
  # YARP Gateway - Bot Detection Layer
  # ===========================================
  gateway:
    build:
      context: .
      dockerfile: Stylobot.Gateway/Dockerfile
    image: stylobot-gateway:demo
    container_name: stylobot-gateway
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      # Gateway configuration
      - GATEWAY_DEMO_MODE=true
      - Gateway__DemoMode__PassAllHeaders=true
      - Gateway__DemoMode__UseVerboseLogging=true
      - ADMIN_SECRET=${ADMIN_SECRET:?Set ADMIN_SECRET in .env}
      # Database (TimescaleDB) - uses gateway's direct env var names
      - DB_PROVIDER=Postgres
      - DB_CONNECTION_STRING=Host=timescaledb;Database=stylobot;Username=stylobot;Password=${POSTGRES_PASSWORD:?Set POSTGRES_PASSWORD in .env}
      # Bot detection
      - BotDetection__BotThreshold=0.7
      - BotDetection__BlockDetectedBots=false
      - BotDetection__LogDetailedReasons=true
      - BotDetection__LogAllRequests=true
      # AI detection (uses local Ollama)
      - BotDetection__AiDetection__Provider=Ollama
      - BotDetection__AiDetection__Ollama__Endpoint=http://ollama:11434
      - BotDetection__AiDetection__Ollama__Model=llama3.2:1b
      - BotDetection__AiDetection__TimeoutMs=5000
      # Response headers (show detection info)
      - BotDetection__ResponseHeaders__Enabled=true
      - BotDetection__ResponseHeaders__IncludeConfidence=true
      - BotDetection__ResponseHeaders__IncludeDetectors=true
      - BotDetection__ResponseHeaders__IncludeProcessingTime=true
      # Use demo policy with all detectors
      - BotDetection__PathPolicies__/*=demo
      # Upstream routing (to demo website)
      - DEFAULT_UPSTREAM=http://website:8080
    volumes:
      - ./demo/config:/app/config:ro
      - gateway-data:/app/data
      - gateway-logs:/app/logs
    expose:
      - "8080"
    depends_on:
      timescaledb:
        condition: service_healthy
      ollama:
        condition: service_started
      website:
        condition: service_healthy
    networks:
      - stylobot-demo
    restart: unless-stopped
    stop_grace_period: 10s
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://localhost:8080/admin/health"]
      interval: 30s
      timeout: 5s
      start_period: 30s
      retries: 3

  # ===========================================
  # Demo Website - Protected Application
  # ===========================================
  website:
    build:
      context: .
      dockerfile: mostlylucid.stylobot.website/Dockerfile
    image: stylobot-website:latest
    container_name: stylobot-website
    env_file:
      - .env
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      # Bot Detection Configuration (can be overridden in .env)
      - BOTDETECTION_THRESHOLD=${BOTDETECTION_THRESHOLD:-0.7}
      - BOTDETECTION_BLOCK_BOTS=${BOTDETECTION_BLOCK_BOTS:-false}
      - BOTDETECTION_LOG_DETAILED=${BOTDETECTION_LOG_DETAILED:-true}
      - BOTDETECTION_LOG_ALL_REQUESTS=${BOTDETECTION_LOG_ALL_REQUESTS:-true}
      # LLM Configuration (remote Ollama, OpenAI, or Anthropic)
      - BOTDETECTION_AI_PROVIDER=${BOTDETECTION_AI_PROVIDER:-Heuristic}
      - BOTDETECTION_OLLAMA_ENDPOINT=${BOTDETECTION_OLLAMA_ENDPOINT:-http://ollama:11434}
      - BOTDETECTION_OLLAMA_MODEL=${BOTDETECTION_OLLAMA_MODEL:-llama3.2:1b}
      - BOTDETECTION_OLLAMA_TIMEOUT_MS=${BOTDETECTION_OLLAMA_TIMEOUT_MS:-5000}
      - BOTDETECTION_OPENAI_API_KEY=${BOTDETECTION_OPENAI_API_KEY:-}
      - BOTDETECTION_OPENAI_MODEL=${BOTDETECTION_OPENAI_MODEL:-gpt-4o-mini}
      - BOTDETECTION_OPENAI_ENDPOINT=${BOTDETECTION_OPENAI_ENDPOINT:-https://api.openai.com/v1}
      - BOTDETECTION_ANTHROPIC_API_KEY=${BOTDETECTION_ANTHROPIC_API_KEY:-}
      - BOTDETECTION_ANTHROPIC_MODEL=${BOTDETECTION_ANTHROPIC_MODEL:-claude-3-haiku-20240307}
      # Signature & privacy
      - BOTDETECTION_SIGNATURE_HASH_KEY=${BOTDETECTION_SIGNATURE_HASH_KEY:-}
      - BOTDETECTION_CLIENTSIDE_TOKEN_SECRET=${BOTDETECTION_CLIENTSIDE_TOKEN_SECRET:-}
      # Dashboard
      - STYLOBOT_DASHBOARD_PATH=${STYLOBOT_DASHBOARD_PATH:-/_stylobot}
      - STYLOBOT_DASHBOARD_MAX_EVENTS=${STYLOBOT_DASHBOARD_MAX_EVENTS:-1000}
      # Database (PostgreSQL/TimescaleDB)
      - DATABASE_PROVIDER=${DATABASE_PROVIDER:-InMemory}
      - DATABASE_CONNECTION_STRING=Host=timescaledb;Database=stylobot;Username=stylobot;Password=${POSTGRES_PASSWORD:?Set POSTGRES_PASSWORD in .env}
      - DATABASE_TIMESCALEDB_ENABLED=${DATABASE_TIMESCALEDB_ENABLED:-true}
      - DATABASE_AUTO_INIT_SCHEMA=${DATABASE_AUTO_INIT_SCHEMA:-true}
      - DATABASE_RETENTION_DAYS=${DATABASE_RETENTION_DAYS:-30}
    volumes:
      - website-data:/app/data
      - website-logs:/app/logs
      - website-config:/app/config
    expose:
      - "8080"
    depends_on:
      timescaledb:
        condition: service_healthy
    networks:
      - stylobot-demo
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 3s
      start_period: 10s
      retries: 3

  # ===========================================
  # TimescaleDB - Detection Event Storage
  # ===========================================
  timescaledb:
    image: timescale/timescaledb:latest-pg16
    container_name: stylobot-timescaledb
    environment:
      - POSTGRES_DB=stylobot
      - POSTGRES_USER=stylobot
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:?Set POSTGRES_PASSWORD in .env}
      - TIMESCALEDB_TELEMETRY=off
    volumes:
      - timescale-data:/var/lib/postgresql/data
      - ./demo/init-db:/docker-entrypoint-initdb.d:ro
    ports:
      - "127.0.0.1:5432:5432"  # Localhost only - for debugging
    networks:
      - stylobot-demo
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U stylobot -d stylobot"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    command:
      - postgres
      - -c
      - shared_buffers=256MB
      - -c
      - effective_cache_size=1GB
      - -c
      - max_connections=100
      - -c
      - work_mem=16MB

  # ===========================================
  # Qdrant - Vector Database
  # ===========================================
  qdrant:
    image: qdrant/qdrant:latest
    container_name: stylobot-qdrant
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
    volumes:
      - qdrant-data:/qdrant/storage
    ports:
      - "127.0.0.1:6333:6333"  # REST API + Dashboard (localhost only)
      - "127.0.0.1:6334:6334"  # gRPC (localhost only)
    networks:
      - stylobot-demo
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://localhost:6333/"]
      interval: 30s
      timeout: 5s
      retries: 3

  # ===========================================
  # Ollama - Local LLM for AI Detection
  # ===========================================
  ollama:
    image: ollama/ollama:latest
    container_name: stylobot-ollama
    volumes:
      - ollama-data:/root/.ollama
    ports:
      - "127.0.0.1:11434:11434"  # Localhost only
    networks:
      - stylobot-demo
    restart: unless-stopped
    # Pull the model on first run
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        /bin/ollama serve &
        sleep 5
        /bin/ollama pull llama3.2:1b
        wait
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    # For CPU-only, comment out the deploy section above

  # ===========================================
  # Redis - Session/Cache (optional)
  # ===========================================
  redis:
    image: redis:7-alpine
    container_name: stylobot-redis
    volumes:
      - redis-data:/data
    ports:
      - "127.0.0.1:6379:6379"  # Localhost only
    networks:
      - stylobot-demo
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-changeme}

# ===========================================
# Networks
# ===========================================
networks:
  stylobot-demo:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

# ===========================================
# Volumes
# ===========================================
volumes:
  # Caddy volumes (SSL certificates, config)
  caddy-data:
    driver: local
  caddy-config:
    driver: local

  # Gateway volumes
  gateway-data:
    driver: local
  gateway-logs:
    driver: local

  # Website volumes
  website-data:
    driver: local
  website-logs:
    driver: local
  website-config:
    driver: local

  # Database volumes
  timescale-data:
    driver: local

  # Vector DB volumes
  qdrant-data:
    driver: local

  # LLM model cache
  ollama-data:
    driver: local

  # Redis cache
  redis-data:
    driver: local
