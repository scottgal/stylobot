@{
    ViewData["Title"] = "Live Demo - We're Detecting You Right Now";
}

<!-- Hero -->
<section class="py-6 lg:py-8 bg-gradient-to-br from-base-100 via-base-200 to-base-100 relative overflow-hidden">
    <div class="absolute inset-0 opacity-5">
        <div class="absolute inset-0" style="background-image: radial-gradient(circle at 2px 2px, currentColor 1px, transparent 0); background-size: 40px 40px;"></div>
    </div>
    <div class="max-w-4xl mx-auto px-4 text-center relative z-10">
        <h1 class="text-2xl lg:text-3xl font-bold mb-2">
            We're detecting <span style="color: #5BA3A3;">you</span> right now.
        </h1>
        <p class="text-sm text-base-content/60 max-w-xl mx-auto">
            Every metric below is real, computed from your actual request using our full detection pipeline.
        </p>
    </div>
</section>

<!-- Detection Card -->
<section class="py-8 bg-base-100">
    <div class="max-w-4xl mx-auto px-4"
         x-data="{
            data: null,
            loading: true,
            error: null,
            connected: false,
            connection: null,
            hitCount: 1,
            justUpdated: false,
            showAllContributions: false,
            showSignals: false,
            signature: '',

            get gaugeColor() {
                if (!this.data) return '#86B59C';
                const p = this.data.botProbability;
                if (p >= 0.7) return '#ef4444';
                if (p >= 0.4) return '#DAA564';
                return '#86B59C';
            },

            get gaugeDash() {
                if (!this.data) return '0 251.3';
                const arcLen = 251.3;
                const fill = this.data.botProbability * arcLen;
                return fill + ' ' + arcLen;
            },

            get topContributions() {
                if (!this.data || !this.data.contributions) return [];
                const sorted = [...this.data.contributions].sort((a, b) => Math.abs(b.impact) - Math.abs(a.impact));
                return this.showAllContributions ? sorted : sorted.slice(0, 5);
            },

            get signalEntries() {
                if (!this.data || !this.data.signals) return [];
                return Object.entries(this.data.signals);
            },

            riskColor(band) {
                const colors = {
                    'VeryLow': '#86B59C', 'Low': '#86B59C', 'Elevated': '#DAA564',
                    'Medium': '#DAA564', 'High': '#ef4444', 'VeryHigh': '#dc2626'
                };
                return colors[band] || '#6b7280';
            },

            async init() {
                await this.fetchDetection();
                this.connectSignalR();
            },

            async fetchDetection() {
                try {
                    const resp = await fetch('/bot-detection/check');
                    if (!resp.ok) throw new Error('Detection endpoint returned ' + resp.status);
                    this.data = await resp.json();
                    this.loading = false;
                } catch (e) {
                    this.error = 'Failed to load detection results: ' + e.message;
                    this.loading = false;
                }
            },

            async connectSignalR() {
                try {
                    if (typeof signalR === 'undefined') {
                        await new Promise((resolve, reject) => {
                            const s = document.createElement('script');
                            s.src = 'https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js';
                            s.onload = resolve;
                            s.onerror = reject;
                            document.head.appendChild(s);
                        });
                    }

                    this.connection = new signalR.HubConnectionBuilder()
                        .withUrl('/_stylobot/hub')
                        .withAutomaticReconnect([0, 2000, 5000, 10000, 30000])
                        .configureLogging(signalR.LogLevel.Warning)
                        .build();

                    this.connection.on('BroadcastDetection', (detection) => {
                        if (this.signature && detection.primarySignature === this.signature) {
                            this.data.isBot = detection.isBot;
                            this.data.botProbability = detection.botProbability;
                            this.data.confidence = detection.confidence;
                            this.data.riskBand = detection.riskBand;
                            this.data.processingTimeMs = detection.processingTimeMs;
                            this.justUpdated = true;
                            setTimeout(() => this.justUpdated = false, 600);
                        }
                    });

                    this.connection.on('BroadcastSignature', (sig) => {
                        if (this.signature && sig.primarySignature === this.signature) {
                            this.hitCount = sig.hitCount;
                        }
                    });

                    this.connection.onclose(() => this.connected = false);
                    this.connection.onreconnecting(() => this.connected = false);
                    this.connection.onreconnected(() => this.connected = true);

                    await this.connection.start();
                    this.connected = true;

                    // Extract signature from the detection bar component
                    const barEl = document.querySelector('.stylobot-detection-bar-container');
                    if (barEl && barEl._x_dataStack) {
                        this.signature = barEl._x_dataStack[0].signature || '';
                    }
                } catch (e) {
                    console.warn('[LiveDemo] SignalR connection failed:', e);
                }
            }
         }"
         x-init="init()">

        <!-- Loading State -->
        <template x-if="loading">
            <div class="card bg-base-200 shadow-xl">
                <div class="card-body items-center text-center py-16">
                    <span class="loading loading-spinner loading-lg" style="color: #5BA3A3;"></span>
                    <p class="text-base-content/60 mt-4">Running detection pipeline...</p>
                </div>
            </div>
        </template>

        <!-- Detection Results -->
        <template x-if="!loading && data">
            <div>
                <!-- Main Detection Card -->
                <div class="card bg-base-200 shadow-xl mb-6">
                    <div class="card-body">
                        <div class="flex flex-col lg:flex-row gap-8 items-center">

                            <!-- SVG Semi-circular Gauge -->
                            <div class="flex-shrink-0">
                                <svg viewBox="0 0 200 130" class="w-56 h-36">
                                    <!-- Background Arc -->
                                    <path d="M 20 110 A 80 80 0 0 1 180 110"
                                          fill="none" stroke="currentColor" stroke-opacity="0.1" stroke-width="14"
                                          stroke-linecap="round" />
                                    <!-- Value Arc -->
                                    <path d="M 20 110 A 80 80 0 0 1 180 110"
                                          fill="none"
                                          :stroke="gaugeColor"
                                          stroke-width="14"
                                          stroke-linecap="round"
                                          :stroke-dasharray="gaugeDash"
                                          style="transition: stroke-dasharray 1s ease-out, stroke 0.5s ease;" />
                                    <!-- Center Text -->
                                    <text x="100" y="85" text-anchor="middle" class="fill-current"
                                          style="font-size: 32px; font-weight: 700;"
                                          x-text="Math.round(data.botProbability * 100) + '%'"></text>
                                    <text x="100" y="108" text-anchor="middle" class="fill-current opacity-60"
                                          style="font-size: 12px;">Bot Probability</text>
                                </svg>
                            </div>

                            <!-- Metrics -->
                            <div class="flex-1 w-full">
                                <div class="flex flex-wrap items-center gap-3 mb-4">
                                    <!-- Classification Badge -->
                                    <div class="badge badge-lg gap-1 py-3 px-4 font-bold text-white"
                                         :class="data.isBot ? 'badge-error' : 'badge-success'">
                                        <span x-text="data.isBot ? 'BOT' : 'HUMAN'"></span>
                                    </div>

                                    <!-- Risk Band Badge -->
                                    <div class="badge badge-lg py-3 px-4 font-semibold"
                                         :style="'background-color:' + riskColor(data.riskBand) + '22; color:' + riskColor(data.riskBand) + '; border-color:' + riskColor(data.riskBand) + '44'"
                                         x-text="data.riskBand"></div>

                                    <!-- Processing Time -->
                                    <div class="badge badge-lg badge-ghost py-3 px-4">
                                        <span x-text="data.processingTimeMs?.toFixed(0) + 'ms'"></span>
                                    </div>

                                    <!-- Hit Counter -->
                                    <div class="badge badge-lg badge-ghost py-3 px-4" :class="{ 'animate-pulse': justUpdated }">
                                        x<span x-text="hitCount"></span>
                                    </div>

                                    <!-- LIVE indicator -->
                                    <div class="flex items-center gap-1.5 ml-auto" x-show="connected">
                                        <span class="relative flex h-2.5 w-2.5">
                                            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                                            <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-green-500"></span>
                                        </span>
                                        <span class="text-xs font-semibold text-green-500">LIVE</span>
                                    </div>
                                </div>

                                <!-- Key Stats Grid -->
                                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                                    <div class="bg-base-300/50 rounded-lg p-3">
                                        <div class="text-xs text-base-content/60 mb-1">Human Prob.</div>
                                        <div class="text-xl font-bold" style="color: #86B59C;" x-text="((1 - data.botProbability) * 100).toFixed(1) + '%'"></div>
                                    </div>
                                    <div class="bg-base-300/50 rounded-lg p-3">
                                        <div class="text-xs text-base-content/60 mb-1">Confidence</div>
                                        <div class="text-xl font-bold" style="color: #5BA3A3;" x-text="(data.confidence * 100).toFixed(1) + '%'"></div>
                                    </div>
                                    <div class="bg-base-300/50 rounded-lg p-3">
                                        <div class="text-xs text-base-content/60 mb-1">Detectors</div>
                                        <div class="text-xl font-bold" x-text="data.detectorCount || 0"></div>
                                    </div>
                                    <div class="bg-base-300/50 rounded-lg p-3">
                                        <div class="text-xs text-base-content/60 mb-1">AI Ran</div>
                                        <div class="text-xl font-bold" x-text="data.aiRan ? 'Yes' : 'No'"
                                             :style="'color:' + (data.aiRan ? '#5BA3A3' : '#6b7280')"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detector Contributions -->
                <div class="card bg-base-200 shadow-xl mb-6">
                    <div class="card-body">
                        <h2 class="card-title text-lg mb-4">
                            Detector Breakdown
                            <span class="badge badge-ghost" x-text="(data.contributions?.length || 0) + ' detectors'"></span>
                        </h2>
                        <div class="space-y-2">
                            <template x-for="(c, i) in topContributions" :key="i">
                                <div class="flex items-center gap-3">
                                    <div class="w-28 text-sm font-medium truncate" x-text="c.detector"></div>
                                    <div class="flex-1 bg-base-300 rounded-full h-5 relative overflow-hidden">
                                        <div class="h-full rounded-full transition-all duration-700 flex items-center justify-end pr-2"
                                             :style="'width:' + Math.max(Math.min(Math.abs(c.impact) * 1000, 100), 4) + '%; background-color:' + (c.impact > 0 ? '#ef444488' : '#86B59C88')">
                                            <span class="text-xs font-semibold text-white drop-shadow"
                                                  x-show="Math.abs(c.impact * 100) > 3"
                                                  x-text="(c.impact > 0 ? '+' : '') + (c.impact * 100).toFixed(1) + '%'"></span>
                                        </div>
                                    </div>
                                    <div class="w-16 text-right text-xs font-mono"
                                         :style="'color:' + (c.impact > 0 ? '#ef4444' : '#86B59C')"
                                         x-text="(c.impact > 0 ? '+' : '') + (c.impact * 100).toFixed(1) + '%'"></div>
                                </div>
                            </template>

                            <!-- Zero-impact detectors note -->
                            <template x-if="data.contributions?.filter(c => c.impact === 0).length > 0">
                                <div class="text-xs text-base-content/50 mt-2 italic"
                                     x-text="data.contributions.filter(c => c.impact === 0).length + ' detectors returned neutral (0% impact)'"></div>
                            </template>
                        </div>

                        <!-- Show more toggle -->
                        <template x-if="data.contributions?.length > 5">
                            <div class="mt-3">
                                <button class="btn btn-ghost btn-sm" @@click="showAllContributions = !showAllContributions"
                                        x-text="showAllContributions ? 'Show top 5' : 'Show all ' + data.contributions.length + ' detectors'"></button>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Signals -->
                <div class="card bg-base-200 shadow-xl mb-6">
                    <div class="card-body">
                        <h2 class="card-title text-lg cursor-pointer" @@click="showSignals = !showSignals">
                            <span>Collected Signals</span>
                            <span class="badge badge-ghost" x-text="signalEntries.length + ' signals'"></span>
                            <svg class="w-4 h-4 ml-auto transition-transform duration-200" :class="{ 'rotate-180': showSignals }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </h2>
                        <div x-show="showSignals" x-transition>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mt-3">
                                <template x-for="[key, val] in signalEntries" :key="key">
                                    <div class="flex items-center gap-2 bg-base-300/50 rounded px-3 py-1.5 text-sm">
                                        <code class="text-xs font-mono opacity-70" x-text="key"></code>
                                        <span class="ml-auto font-medium text-xs"
                                              :style="'color:' + (val === true ? '#86B59C' : val === false ? '#ef4444' : '#6b7280')"
                                              x-text="String(val)"></span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recommended Action -->
                <div class="card bg-base-200 shadow-xl mb-6">
                    <div class="card-body">
                        <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4">
                            <div>
                                <div class="text-xs text-base-content/60 mb-1">Recommended Action</div>
                                <div class="text-xl font-bold"
                                     :style="'color:' + riskColor(data.riskBand)"
                                     x-text="data.recommendedAction?.action || 'Allow'"></div>
                            </div>
                            <div class="flex-1">
                                <div class="text-xs text-base-content/60 mb-1">Reason</div>
                                <div class="text-sm text-base-content/80" x-text="data.recommendedAction?.reason || ''"></div>
                            </div>
                            <div>
                                <div class="text-xs text-base-content/60 mb-1">Policy</div>
                                <div class="badge badge-ghost" x-text="data.policy || 'default'"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detectors List -->
                <div class="card bg-base-200 shadow-xl mb-6">
                    <div class="card-body">
                        <h2 class="card-title text-lg mb-2">Detectors Ran</h2>
                        <div class="flex flex-wrap gap-2">
                            <template x-for="name in (data.detectorsRan || [])" :key="name">
                                <div class="badge badge-outline badge-sm py-2 px-3" x-text="name"></div>
                            </template>
                        </div>
                        <template x-if="data.failedDetectors?.length > 0">
                            <div class="mt-3">
                                <div class="text-xs text-error mb-1">Failed Detectors</div>
                                <div class="flex flex-wrap gap-2">
                                    <template x-for="name in data.failedDetectors" :key="name">
                                        <div class="badge badge-error badge-outline badge-sm" x-text="name"></div>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </template>

        <!-- Error State -->
        <template x-if="error">
            <div class="alert alert-warning mb-6">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z" />
                </svg>
                <span x-text="error"></span>
            </div>
        </template>

        <!-- Privacy Note -->
        <div class="text-center py-8">
            <div class="inline-flex items-center gap-2 bg-base-200 rounded-full px-5 py-2.5 text-sm text-base-content/70">
                <svg class="w-4 h-4" style="color: #86B59C;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                </svg>
                <span><strong>Zero PII collected.</strong> All detection uses privacy-safe signals. No IP addresses or personal data are stored.</span>
            </div>
        </div>
    </div>
</section>

<!-- What the Metrics Mean -->
<section class="py-8 bg-base-200">
    <div class="max-w-4xl mx-auto px-4">
        <h2 class="text-lg font-bold mb-6 text-center">What These Metrics Mean</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-base-100 rounded-lg p-5">
                <h3 class="font-bold mb-2" style="color: #5BA3A3;">Bot Probability</h3>
                <p class="text-sm text-base-content/70">How likely this request came from a bot (0-100%). Aggregated from all detectors using weighted voting.</p>
            </div>
            <div class="bg-base-100 rounded-lg p-5">
                <h3 class="font-bold mb-2" style="color: #5BA3A3;">Confidence</h3>
                <p class="text-sm text-base-content/70">How certain we are about the classification. High confidence means strong agreement between detectors.</p>
            </div>
            <div class="bg-base-100 rounded-lg p-5">
                <h3 class="font-bold mb-2" style="color: #5BA3A3;">Risk Band</h3>
                <p class="text-sm text-base-content/70">Categorized risk level from VeryLow to VeryHigh. Determines the recommended response action.</p>
            </div>
            <div class="bg-base-100 rounded-lg p-5">
                <h3 class="font-bold mb-2" style="color: #5BA3A3;">Detector Breakdown</h3>
                <p class="text-sm text-base-content/70">Each detector's individual contribution. Green bars push toward human, red bars push toward bot.</p>
            </div>
        </div>
    </div>
</section>

<!-- CTA -->
<section class="py-8 bg-base-100">
    <div class="max-w-4xl mx-auto px-4 text-center">
        <h2 class="text-lg font-bold mb-3">Add This To Your App</h2>
        <p class="text-sm text-base-content/70 mb-5 max-w-2xl mx-auto">
            Get the same detection intelligence on your own site. Drop-in ASP.NET middleware, YARP gateway, or standalone npm widget.
        </p>
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
            <a href="https://www.nuget.org/packages/mostlylucid.botdetection" target="_blank" class="btn btn-primary gap-2">
                NuGet Package
            </a>
            <a href="https://hub.docker.com/r/scottgal/mostlylucid.yarpgateway" target="_blank" class="btn btn-outline gap-2">
                Docker Image
            </a>
            <a href="https://github.com/scottgal/mostlylucid.nugetpackages/blob/main/Mostlylucid.BotDetection/README.md" target="_blank" class="btn btn-outline gap-2">
                Documentation
            </a>
        </div>
    </div>
</section>
