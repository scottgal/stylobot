@using Mostlylucid.BotDetection.UI.Models
@model DashboardShellModel
@{
    ViewData["Title"] = "Live Dashboard";
    var bp = Model.BasePath;
    var tab = Model.ActiveTab;
    // Tab links go to MVC route, HTMX partial calls use bp (middleware path)
    string TabUrl(string t) => $"/Dashboard?tab={t}";
    string TabClass(string t) => tab == t
        ? "bg-base-100 shadow-sm text-base-content font-semibold"
        : "text-base-content/40 hover:text-base-content/60";
    var cspNonce = Model.CspNonce;
}

<!-- Command Center Dashboard -->
<div class="max-w-7xl mx-auto px-2 py-4" hx-headers='{"X-Requested-With": "XMLHttpRequest"}'>

    <!-- Header: Title + Connection Status -->
    <div class="flex items-center gap-3 mb-4">
        <h1 class="text-lg font-bold text-base-content">Command Center</h1>
        <span class="text-xs font-medium px-2 py-0.5 rounded-full bg-base-200 text-base-content/50 border border-base-300 flex items-center gap-1.5">
            <span class="relative flex h-1.5 w-1.5">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full opacity-75 live-dot"></span>
                <span class="relative inline-flex rounded-full h-1.5 w-1.5 live-dot"></span>
            </span>
            Real-time
        </span>
        <span id="sb-connection-status" class="w-2 h-2 rounded-full sb-disconnected" title="SignalR: disconnected"></span>
    </div>

    <!-- Summary Stats Bar -->
    @await Html.PartialAsync("~/Views/Dashboard/_SummaryStats.cshtml", Model.Summary)

    <!-- Tab navigation â€” always visible -->
    <div class="flex items-center gap-1 my-4 bg-base-300/50 rounded-lg p-0.5 w-fit">
        <a href="@TabUrl("overview")" class="px-3 py-1.5 text-xs font-medium rounded-md transition-all @TabClass("overview")">Overview</a>
        <a href="@TabUrl("visitors")" class="px-3 py-1.5 text-xs font-medium rounded-md transition-all @TabClass("visitors")">Visitors</a>
        <a href="@TabUrl("countries")" class="px-3 py-1.5 text-xs font-medium rounded-md transition-all @TabClass("countries")">Countries</a>
        <a href="@TabUrl("clusters")" class="px-3 py-1.5 text-xs font-medium rounded-md transition-all @TabClass("clusters")">Clusters</a>
        <a href="@TabUrl("useragents")" class="px-3 py-1.5 text-xs font-medium rounded-md transition-all @TabClass("useragents")">User Agents</a>
    </div>

    @if (tab == "overview")
    {
        <!-- Two-column layout: Viz left, Data right -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">

            <!-- LEFT COLUMN: Map, Graph, Your Detection -->
            <div class="flex flex-col gap-4">
                <!-- World Map -->
                <div class="rounded-xl border overflow-hidden command-map-container" style="border-color: var(--sb-card-border); background: var(--sb-card-bg);">
                    <div class="flex items-center justify-between px-3 py-1.5 border-b" style="border-color: var(--sb-card-divider);">
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] font-semibold text-base-content/70">GLOBAL THREAT MAP</span>
                            <span class="text-[9px] px-1 py-0.5 rounded status-badge-danger font-medium">LIVE</span>
                        </div>
                    </div>
                    <div id="command-map" class="relative" style="height: 440px;"></div>
                </div>

                <!-- Time Series Chart -->
                <div class="rounded-xl border overflow-hidden" style="border-color: var(--sb-card-border); background: var(--sb-card-bg);">
                    <div class="flex items-center justify-between px-3 py-1.5 border-b" style="border-color: var(--sb-card-divider);">
                        <span class="text-[10px] font-semibold text-base-content/70">TRAFFIC OVER TIME</span>
                        <span class="text-[9px] text-base-content/40">Last 6 hours</span>
                    </div>
                    <div class="p-2">
                        <div id="time-chart" style="height: 160px;"></div>
                    </div>
                </div>

                <!-- Your Detection (compact) -->
                @await Html.PartialAsync("~/Views/Dashboard/_YourDetection.cshtml", Model.YourDetection)
            </div>

            <!-- RIGHT COLUMN: Top Bots, Recent Activity -->
            <div class="flex flex-col gap-4">
                @await Html.PartialAsync("~/Views/Dashboard/_TopBotsList.cshtml", Model.TopBots)
                @await Html.PartialAsync("~/Views/Dashboard/_RecentActivity.cshtml", Model.Visitors)
            </div>
        </div>
    }
    else if (tab == "visitors")
    {
        @await Html.PartialAsync("~/Views/Dashboard/_VisitorList.cshtml", Model.Visitors)
    }
    else if (tab == "countries")
    {
        <!-- Country map + table -->
        <div class="rounded-xl border overflow-hidden mb-4" style="border-color: var(--sb-card-border); background: var(--sb-card-bg);">
            <div class="flex items-center justify-between px-3 py-1.5 border-b" style="border-color: var(--sb-card-divider);">
                <div class="flex items-center gap-2">
                    <span class="text-[10px] font-semibold text-base-content/70">GLOBAL THREAT MAP</span>
                    <span class="text-[9px] px-1 py-0.5 rounded status-badge-danger font-medium">LIVE</span>
                </div>
            </div>
            <div id="countries-map" class="relative" style="height: 440px;"></div>
        </div>
        @await Html.PartialAsync("~/Views/Dashboard/_CountriesList.cshtml", Model.Countries)
    }
    else if (tab == "clusters")
    {
        @await Html.PartialAsync("~/Views/Dashboard/_ClustersList.cshtml", Model.Clusters)
    }
    else if (tab == "useragents")
    {
        @await Html.PartialAsync("~/Views/Dashboard/_UserAgentsList.cshtml", Model.UserAgents)
    }

    <!-- Dashboard version footer -->
    @if (!string.IsNullOrEmpty(Model.Version))
    {
        <div class="text-xs text-base-content/30 text-right mt-4 py-2">
            StyloBot Detection Engine v@(Model.Version)
        </div>
    }
</div>

@section Scripts {
    <!-- SignalR client -->
    <script src="https://cdn.jsdelivr.net/npm/@@microsoft/signalr@@8.0.0/dist/browser/signalr.min.js" nonce="@cspNonce"></script>

    <!-- SignalR -> HTMX coordinator (for widget live updates) -->
    <script nonce="@cspNonce">
    (function() {
        'use strict';

        var BASE = '@Html.Raw(bp)';
        var HUB  = '@Html.Raw(Model.HubPath)';

        // Widget registry: discovers widgets via data-sb-widget / data-sb-depends
        function getWidgetMap() {
            var map = {};
            document.querySelectorAll('[data-sb-widget]').forEach(function(el) {
                var deps = (el.getAttribute('data-sb-depends') || '').split(',');
                deps.forEach(function(dep) {
                    dep = dep.trim();
                    if (!dep) return;
                    if (!map[dep]) map[dep] = [];
                    var wid = el.getAttribute('data-sb-widget');
                    if (map[dep].indexOf(wid) === -1) map[dep].push(wid);
                });
            });
            return map;
        }

        // Debounced OOB updater
        var pending = {};
        var debounceTimer = null;
        var DEBOUNCE_MS = 500;

        function invalidate(signal) {
            var widgetMap = getWidgetMap();
            var widgets = widgetMap[signal] || [];
            widgets.forEach(function(w) { pending[w] = true; });
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(flush, DEBOUNCE_MS);
        }

        function flush() {
            var ids = Object.keys(pending);
            if (ids.length === 0) return;
            pending = {};
            var url = BASE + '/partials/update?widgets=' + ids.join(',');
            if (typeof htmx !== 'undefined') {
                htmx.ajax('GET', url, { target: 'body', swap: 'none' });
            }
        }

        // SignalR connection (HTMX coordinator only - viz SignalR is handled by dashboard-viz.ts)
        var connection = new signalR.HubConnectionBuilder()
            .withUrl(HUB)
            .withAutomaticReconnect([0, 1000, 2000, 5000, 10000, 30000])
            .configureLogging(signalR.LogLevel.Warning)
            .build();

        // SignalR is beacon-only: server sends lightweight invalidation signals,
        // client triggers HTMX partial refreshes. No data payloads over the wire.
        connection.on('BroadcastInvalidation', function(signal) { if (signal) invalidate(signal); });

        connection.onreconnecting(function() {
            var el = document.getElementById('sb-connection-status');
            if (el) { el.className = 'w-2 h-2 rounded-full sb-connecting'; el.title = 'SignalR: connecting'; }
        });
        connection.onreconnected(function() {
            var el = document.getElementById('sb-connection-status');
            if (el) { el.className = 'w-2 h-2 rounded-full sb-connected'; el.title = 'SignalR: connected'; }
        });
        connection.onclose(function() {
            var el = document.getElementById('sb-connection-status');
            if (el) { el.className = 'w-2 h-2 rounded-full sb-disconnected'; el.title = 'SignalR: disconnected'; }
        });

        connection.start()
            .then(function() {
                var el = document.getElementById('sb-connection-status');
                if (el) { el.className = 'w-2 h-2 rounded-full sb-connected'; el.title = 'SignalR: connected'; }
            })
            .catch(function() {
                var el = document.getElementById('sb-connection-status');
                if (el) { el.className = 'w-2 h-2 rounded-full sb-disconnected'; el.title = 'SignalR: disconnected'; }
            });
    })();
    </script>
}
