@page
@model YarpProxyDemoModel
@{
    ViewData["Title"] = "YARP Proxy Bot Detection Demo";
}

<link rel="stylesheet" href="~/_content/Mostlylucid.BotDetection.UI/bot-detection-details.css"/>

<div class="container mt-4">
    <h1>YARP Proxy Bot Detection Demo</h1>
    <p class="lead">This page demonstrates bot detection when running behind a YARP reverse proxy (like the Console
        Gateway).</p>

    <div class="alert alert-info">
        <h5>Architecture</h5>
        <p class="mb-0">
            <code>Client ‚Üí YARP Gateway (Console/YarpGateway) ‚Üí This Backend App</code>
        </p>
        <p class="mb-0 mt-2">
            Bot detection runs in the gateway and forwards results via HTTP headers
            (<code>X-Bot-Detection-*</code>). This page reads those headers and displays the detection details.
        </p>
    </div>

    <details class="bot-detection-details-wrapper" open>
        <summary class="bot-detection-summary">
            <span class="summary-icon">üîç</span>
            <span class="summary-text">Bot Detection Details</span>
        </summary>
        <div class="bot-detection-content">
            <bot-detection-details/>
        </div>
    </details>

    <div class="card mt-4">
        <div class="card-header bg-secondary text-white">
            <h4>How It Works</h4>
        </div>
        <div class="card-body">
            <h5>1. Gateway Detection</h5>
            <p>The YARP gateway (Console or YarpGateway project) runs bot detection middleware and analyzes the incoming
                request.</p>

            <h5>2. Header Forwarding</h5>
            <p>Detection results are serialized and forwarded to the backend app via custom headers:</p>
            <ul>
                <li><code>X-Bot-Detection-Result</code> - Boolean (true/false)</li>
                <li><code>X-Bot-Detection-Probability</code> - Bot probability (0.0-1.0)</li>
                <li><code>X-Bot-Detection-Confidence</code> - Detection confidence (0.0-1.0)</li>
                <li><code>X-Bot-Detection-RiskBand</code> - Risk level (VeryLow, Low, Medium, High, VeryHigh)</li>
                <li><code>X-Bot-Detection-Reasons</code> - JSON array of detection reasons</li>
                <li><code>X-Bot-Detection-Contributions</code> - JSON array of detector contributions</li>
            </ul>

            <h5>3. Backend Display</h5>
            <p>This page uses the <code>&lt;bot-detection-details&gt;</code> tag helper which automatically:</p>
            <ul>
                <li>Reads headers if running behind YARP proxy</li>
                <li>Falls back to HttpContext.Items if running inline</li>
                <li>Displays detection results in plain English</li>
            </ul>

            <h5>4. Zero-PII Architecture</h5>
            <p>
                All detection happens in-memory at the gateway. No raw IP addresses or user agents are stored.
                If signatures are enabled, they use HMAC-SHA256 hashing with secret keys for privacy-safe pattern
                detection.
            </p>
        </div>
    </div>

    <div class="card mt-4">
        <div class="card-header bg-primary text-white">
            <h4>Testing the Gateway</h4>
        </div>
        <div class="card-body">
            <p>To test with the console gateway:</p>
            <pre class="bg-light p-3"><code># Start the backend app (this demo)
dotnet run --project Mostlylucid.BotDetection.Demo

# In another terminal, start the console gateway
cd Mostlylucid.BotDetection.Console
dotnet run -- --upstream http://localhost:5000 --port 5100 --mode demo

# Access via the gateway
curl http://localhost:5100/YarpProxyDemo</code></pre>

            <p class="mt-3">You can also build the AOT native executable for production:</p>
            <pre class="bg-light p-3"><code># Build native executable
dotnet publish -c Release -r linux-x64

# Run the tiny gateway (cross-platform, single-file, ~10MB)
./bin/Release/net9.0/linux-x64/publish/minigw --upstream http://backend:8080 --port 80 --mode production</code></pre>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(Model.RequestId))
    {
        <div class="card mt-4">
            <div class="card-header bg-success text-white">
                <h4>Current Request Info</h4>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-3">Request ID</dt>
                    <dd class="col-sm-9"><code>@Model.RequestId</code></dd>

                    <dt class="col-sm-3">Timestamp</dt>
                    <dd class="col-sm-9">@DateTime.UtcNow.ToString("yyyy-MM-dd HH:mm:ss UTC")</dd>

                    @if (Model.IsProxied)
                    {
                        <dt class="col-sm-3">Proxy Status</dt>
                        <dd class="col-sm-9">
                            <span class="badge bg-warning">Behind YARP Proxy</span>
                        </dd>
                    }
                    else
                    {
                        <dt class="col-sm-3">Proxy Status</dt>
                        <dd class="col-sm-9">
                            <span class="badge bg-secondary">Direct (Inline Middleware)</span>
                        </dd>
                    }
                </dl>
            </div>
        </div>
    }
</div>

<style>
    /* Details tag styling for bot detection */
    .bot-detection-details-wrapper {
        border: 2px solid #667eea;
        border-radius: 8px;
        margin: 20px 0;
        background: #fff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .bot-detection-summary {
        padding: 16px 20px;
        font-size: 18px;
        font-weight: 600;
        color: #667eea;
        cursor: pointer;
        user-select: none;
        display: flex;
        align-items: center;
        gap: 12px;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
        border-radius: 6px;
        transition: background 0.2s ease;
    }

    .bot-detection-summary:hover {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
    }

    .bot-detection-summary::marker {
        color: #667eea;
        font-size: 1.2em;
    }

    .summary-icon {
        font-size: 24px;
    }

    .summary-text {
        flex: 1;
    }

    .bot-detection-content {
        padding: 20px;
    }

    /* Code blocks */
    pre code {
        font-size: 13px;
        line-height: 1.5;
    }

    /* Card enhancements */
    .card {
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .card-header {
        border-radius: 8px 8px 0 0 !important;
        font-weight: 600;
    }

    /* Definition list styling */
    dl.row dt {
        font-weight: 600;
        color: #586069;
    }

    dl.row dd code {
        background: #f6f8fa;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 13px;
    }
</style>
