@model Mostlylucid.BotDetection.UI.Models.DetectionDisplayModel

@if (!Model.HasData)
{
    <div class="bot-detection-no-data">
        <p>No bot detection data available</p>
    </div>
    return;
}

@{
    var recommendedAction = Model.BotProbability switch
    {
        >= 0.9 => ("Block", "Very high confidence bot - immediate block recommended"),
        >= 0.7 => ("Challenge", "High confidence bot - CAPTCHA or verification recommended"),
        >= 0.5 => ("Throttle", "Moderate bot signals - rate limiting recommended"),
        >= 0.3 => ("Monitor", "Some bot signals - monitor behavior"),
        _ => ("Allow", "Low bot probability - normal access")
    };
    var detectorCount = Model.DetectorContributions?.Count ?? 0;
    var aiRan = Model.DetectorContributions?.Any(d => d.Name?.Contains("Llm") == true || d.Name?.Contains("AI") == true) ?? false;
}

<div class="bot-detection-container bot-detection-compact" x-data="{ showDetails: false, showSignatures: false }">
    <!-- Compact Header with Key Metrics -->
    <div class="bot-detection-header">
        <div class="bot-detection-status @(Model.IsBot ? "is-bot" : "is-human")">
            <span class="status-icon">@(Model.IsBot ? "ü§ñ" : "üë§")</span>
            <span class="status-text">@(Model.IsBot ? "Bot" : "Human")</span>
        </div>
        <div class="bot-detection-score">
            <div class="score-label">Bot Probability</div>
            <div class="score-value">@Model.BotProbability.ToString("P0")</div>
        </div>
        <div class="bot-detection-risk">
            <div class="risk-label">Risk</div>
            <div class="risk-value risk-@Model.RiskBand.ToLower()">@Model.RiskBand</div>
        </div>
        <div class="bot-detection-recommendation">
            <div class="recommendation-label">Recommendation</div>
            <div class="recommendation-value action-@recommendedAction.Item1.ToLower()">@recommendedAction.Item1</div>
        </div>
        <div class="bot-detection-timing">
            <div class="timing-label">Fast Path</div>
            <div class="timing-value">@Model.ProcessingTimeMs.ToString("F0")ms</div>
        </div>
    </div>

    <!-- Quick Summary Bar -->
    <div class="bot-detection-summary">
        <span class="summary-item">
            <strong>@detectorCount</strong> detectors ran
        </span>
        <span class="summary-item">
            <strong>@(aiRan ? "AI" : "Heuristic")</strong> analysis
        </span>
        @if (!string.IsNullOrEmpty(Model.PolicyName))
        {
            <span class="summary-item">
                Policy: <strong>@Model.PolicyName</strong>
            </span>
        }
        @if (Model.Signatures?.FactorCount > 0)
        {
            <span class="summary-item">
                <strong>@Model.Signatures.FactorCount</strong> signature factors
            </span>
        }
    </div>

    <!-- Recommendation Explanation -->
    <div class="bot-detection-recommendation-detail">
        <span class="recommendation-reason">@recommendedAction.Item2</span>
        @if (!string.IsNullOrEmpty(Model.BotName))
        {
            <span class="recommendation-bot"> | Identified: <strong>@Model.BotName</strong></span>
        }
    </div>

    <!-- Top Reasons (always visible, compact) -->
    @if (Model.TopReasons.Any())
    {
        <div class="bot-detection-reasons-compact">
            <strong>Key signals:</strong>
            @string.Join(" | ", Model.TopReasons.Take(3))
        </div>
    }

    <!-- Expandable Signatures Section -->
    @if (Model.Signatures != null && Model.Signatures.AvailableFactors.Any())
    {
        <div class="bot-detection-signatures-compact">
            <button type="button" class="toggle-btn" @@click="showSignatures = !showSignatures">
                <span x-text="showSignatures ? '‚ñº' : '‚ñ∂'"></span>
                üîê Signatures (@Model.Signatures.FactorCount factors) - Zero PII
            </button>
            <div x-show="showSignatures" x-collapse class="signatures-content">
                <div class="factors-grid">
                    @if (!string.IsNullOrEmpty(Model.Signatures.PrimarySignature))
                    {
                        <div class="factor-compact"><span class="factor-label">Primary:</span> <code>@Model.Signatures.PrimarySignature</code></div>
                    }
                    @if (!string.IsNullOrEmpty(Model.Signatures.IpSignature))
                    {
                        <div class="factor-compact"><span class="factor-label">IP:</span> <code>@Model.Signatures.IpSignature</code></div>
                    }
                    @if (!string.IsNullOrEmpty(Model.Signatures.UaSignature))
                    {
                        <div class="factor-compact"><span class="factor-label">UA:</span> <code>@Model.Signatures.UaSignature</code></div>
                    }
                    @if (!string.IsNullOrEmpty(Model.Signatures.ClientSideSignature))
                    {
                        <div class="factor-compact"><span class="factor-label">Browser:</span> <code>@Model.Signatures.ClientSideSignature</code></div>
                    }
                </div>
                <div class="privacy-note">All signatures are HMAC-SHA256 hashed. No PII stored.</div>
            </div>
        </div>
    }

    <!-- Expandable Detector Details -->
    @if (Model.DetectorContributions.Any())
    {
        <div class="bot-detection-details-compact">
            <button type="button" class="toggle-btn" @@click="showDetails = !showDetails">
                <span x-text="showDetails ? '‚ñº' : '‚ñ∂'"></span>
                üìä Detector Details (@detectorCount detectors)
            </button>
            <div x-show="showDetails" x-collapse class="details-content">
                <div class="contributions-compact">
                    @foreach (var detector in Model.DetectorContributions.OrderByDescending(d => Math.Abs(d.Contribution)))
                    {
                        var contributionPercent = detector.Contribution * 100;
                        var contributionClass = detector.Contribution > 0 ? "positive" : "negative";
                        <div class="contribution-row">
                            <span class="detector-name-compact">@detector.Name</span>
                            <span class="contribution-value-compact @contributionClass">@contributionPercent.ToString("+0.0;-0.0;0")%</span>
                            <span class="detector-time-compact">@detector.ExecutionTimeMs.ToString("F0")ms</span>
                            @if (!string.IsNullOrEmpty(detector.Reason))
                            {
                                <span class="detector-reason-compact">@detector.Reason</span>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    }

    <!-- Compact Footer -->
    <div class="bot-detection-footer-compact">
        <span>ID: @Model.RequestId</span>
        <span>@Model.Timestamp.ToString("HH:mm:ss")</span>
    </div>
</div>
