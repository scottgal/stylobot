@using Mostlylucid.BotDetection.UI.Models
@model SignatureDetailModel
@{
    Layout = null;
    var bp = Model.BasePath;
    static bool HasFlag(string? code) => !string.IsNullOrEmpty(code) && code.Length == 2 && code != "XX";
    static string FlagUrl(string code) => $"https://flagcdn.com/w40/{code.ToLowerInvariant()}.png";

    string RiskColor(string? risk) => risk switch
    {
        "VeryHigh" => "text-error",
        "High" => "text-error",
        "Elevated" => "text-warning",
        "Medium" => "text-warning",
        _ => "text-success"
    };

    string ActionColor(string? action) => action switch
    {
        "Block" or "Blocked" => "text-error",
        "Throttle" or "throttle-stealth" => "text-warning",
        "Challenge" => "text-warning",
        _ => "text-success"
    };

    string ThreatColor(string? band) => band switch
    {
        "Critical" => "text-error",
        "High" => "text-error",
        "Elevated" => "text-warning",
        "Low" => "text-success",
        _ => "text-base-content/50"
    };

    string ThreatBgColor(string? band) => band switch
    {
        "Critical" => "bg-error/20 text-error border-error/30",
        "High" => "bg-error/15 text-error border-error/20",
        "Elevated" => "bg-warning/15 text-warning border-warning/20",
        "Low" => "bg-success/15 text-success border-success/20",
        _ => "bg-base-300 text-base-content/60 border-base-content/10"
    };

    var timeAgo = Model.LastSeen == default ? "unknown" : FormatTimeAgo(DateTime.UtcNow - Model.LastSeen);
    string FormatTimeAgo(TimeSpan span)
    {
        if (span.TotalSeconds < 5) return "now";
        if (span.TotalSeconds < 60) return $"{(int)span.TotalSeconds}s ago";
        if (span.TotalHours < 1) return $"{(int)span.TotalMinutes}m ago";
        if (span.TotalDays < 1) return $"{(int)span.TotalHours}h {span.Minutes}m ago";
        return $"{(int)span.TotalDays}d ago";
    }
}
<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@(Model.Found ? (Model.BotName ?? "Signature") : "Not Found") - StyloBot</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daisyui@@4.6.0/dist/full.min.css" />
    <script src="https://cdn.tailwindcss.com" nonce="@Model.CspNonce"></script>
    <link rel="stylesheet" href="https://unpkg.com/boxicons@@2.1.4/css/boxicons.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Raleway:wght@700;800;900&display=swap" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/apexcharts" nonce="@Model.CspNonce"></script>
    <script nonce="@Model.CspNonce">
        (function() {
            try {
                var saved = localStorage.getItem('sb-theme');
                if (saved) document.documentElement.setAttribute('data-theme', saved);
                else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches)
                    document.documentElement.setAttribute('data-theme', 'light');
            } catch(e) {}
        })();
    </script>
    <style nonce="@Model.CspNonce">
        [data-theme="dark"] {
            --sb-brand-muted: #6b7280;
            --sb-accent: #5ba3a3;
            --sb-surface: #0b1220;
            --sb-card-bg: #141f33;
            --sb-card-border: rgba(91, 163, 163, 0.28);
            --sb-card-divider: rgba(148, 163, 184, 0.18);
        }
        [data-theme="light"] {
            --sb-brand-muted: #475569;
            --sb-accent: #0f766e;
            --sb-surface: #f8fafc;
            --sb-card-bg: #ffffff;
            --sb-card-border: rgba(15, 118, 110, 0.18);
            --sb-card-divider: rgba(15, 23, 42, 0.1);
        }
        body { font-family: 'Inter', sans-serif; background: var(--sb-surface); }
        .brand-header {
            background: linear-gradient(120deg, color-mix(in oklab, var(--sb-surface) 78%, #0f172a), color-mix(in oklab, var(--sb-card-bg) 70%, #0f172a));
            border-bottom: 1px solid var(--sb-card-divider);
        }
        .impact-bar { height: 6px; border-radius: 3px; background: var(--sb-card-divider); }
        .impact-bar-fill { height: 100%; border-radius: 3px; }
    </style>
</head>
<body class="min-h-screen" hx-history="false">

    <!-- Brand header -->
    <header class="brand-header px-4 py-3">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
                <a href="@bp" class="text-lg font-black tracking-tight" style="font-family: 'Raleway', sans-serif;">
                    <span style="color: var(--sb-brand-muted);">stylo</span><span style="color: var(--sb-brand-strong);">bot</span>
                </a>
                <span class="text-xs font-medium px-2 py-0.5 rounded-full"
                      style="background: var(--sb-card-bg); color: var(--sb-brand-muted); border: 1px solid var(--sb-card-border);">
                    Signature Detail
                </span>
            </div>
            <button onclick="document.documentElement.setAttribute('data-theme', document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'); try { localStorage.setItem('sb-theme', document.documentElement.getAttribute('data-theme')); } catch(e) {}"
                    class="btn btn-ghost btn-xs btn-circle">
                <i class="bx bx-moon text-sm"></i>
            </button>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-4">

@if (!Model.Found)
{
    <div class="rounded-xl border p-8 text-center" style="border-color: var(--sb-card-border); background: var(--sb-card-bg);">
        <h2 class="text-lg font-bold text-base-content/70 mb-2">Signature Not Found</h2>
        <p class="text-sm text-base-content/50 mb-4">The signature <code class="text-xs bg-base-300 px-1 py-0.5 rounded">@Model.SignatureId</code> was not found in the cache.</p>
        <p class="text-xs text-base-content/40">It may have been evicted or the system may have restarted.</p>
        <a href="@bp" class="btn btn-sm btn-ghost mt-4">&larr; Back to Dashboard</a>
    </div>
}
else
{
    <!-- Breadcrumb -->
    <div class="flex items-center gap-2 mb-4 text-xs text-base-content/50">
        <a href="@bp" class="hover:text-base-content/70">&larr; Dashboard</a>
        <span>/</span>
        <span class="text-base-content/70">Signature Detail</span>
    </div>

    <!-- Header -->
    <div class="flex items-center gap-3 mb-2">
        @if (HasFlag(Model.CountryCode))
        {
            <img src="@FlagUrl(Model.CountryCode!)" alt="@Model.CountryCode" class="w-6 h-4 object-cover rounded-sm" />
        }
        <h1 class="text-lg font-bold text-base-content">@(Model.BotName ?? "Unknown Bot")</h1>
        @if (Model.IsBot)
        {
            <span class="text-[10px] px-1.5 py-0.5 rounded font-semibold bg-error/20 text-error">Bot</span>
        }
        else
        {
            <span class="text-[10px] px-1.5 py-0.5 rounded font-semibold bg-success/20 text-success">Human</span>
        }
    </div>

    <!-- Intent & Threat (KEY info) -->
    <div class="flex items-center gap-3 mb-4 flex-wrap">
        @if (!string.IsNullOrEmpty(Model.BotType))
        {
            <div class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg border @ThreatBgColor(Model.ThreatBand)">
                <span class="text-xs font-bold">@Model.BotType</span>
                @if (!string.IsNullOrEmpty(Model.ThreatBand) && Model.ThreatBand != "None")
                {
                    <span class="text-[10px] opacity-70">@Model.ThreatBand threat</span>
                }
            </div>
        }
        @if (Model.ThreatScore.HasValue && Model.ThreatScore.Value > 0)
        {
            <div class="flex items-center gap-1.5 text-xs">
                <span class="text-base-content/50">Threat Score:</span>
                <span class="font-bold @ThreatColor(Model.ThreatBand)">@($"{Model.ThreatScore.Value:F3}")</span>
            </div>
        }
        @if (!string.IsNullOrEmpty(Model.Action))
        {
            <div class="flex items-center gap-1.5 text-xs">
                <span class="text-base-content/50">Policy:</span>
                <span class="font-bold @ActionColor(Model.Action)">@Model.Action</span>
            </div>
        }
    </div>

    <!-- Stats grid -->
    <div class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-6 gap-3 mb-4">
        <div class="rounded-lg border p-3" style="border-color: var(--sb-card-border); background: var(--sb-card-bg);">
            <div class="text-[10px] font-semibold text-base-content/50 uppercase">Probability</div>
            <div class="text-lg font-bold @(Model.BotProbability >= 0.7 ? "text-error" : Model.BotProbability >= 0.4 ? "text-warning" : "text-success")">@($"{Model.BotProbability:P0}")</div>
        </div>
        <div class="rounded-lg border p-3" style="border-color: var(--sb-card-border); background: var(--sb-card-bg);">
            <div class="text-[10px] font-semibold text-base-content/50 uppercase">Confidence</div>
            <div class="text-lg font-bold text-base-content">@($"{Model.Confidence:P0}")</div>
        </div>
        <div class="rounded-lg border p-3" style="border-color: var(--sb-card-border); background: var(--sb-card-bg);">
            <div class="text-[10px] font-semibold text-base-content/50 uppercase">Risk</div>
            <div class="text-lg font-bold @RiskColor(Model.RiskBand)">@(Model.RiskBand ?? "Unknown")</div>
        </div>
        <div class="rounded-lg border p-3" style="border-color: var(--sb-card-border); background: var(--sb-card-bg);">
            <div class="text-[10px] font-semibold text-base-content/50 uppercase">Threat</div>
            <div class="text-lg font-bold @ThreatColor(Model.ThreatBand)">@(Model.ThreatBand ?? "None")</div>
        </div>
        <div class="rounded-lg border p-3" style="border-color: var(--sb-card-border); background: var(--sb-card-bg);">
            <div class="text-[10px] font-semibold text-base-content/50 uppercase">Hit Count</div>
            <div class="text-lg font-bold text-base-content">@Model.HitCount.ToString("N0")</div>
        </div>
        <div class="rounded-lg border p-3" style="border-color: var(--sb-card-border); background: var(--sb-card-bg);">
            <div class="text-[10px] font-semibold text-base-content/50 uppercase">Last Seen</div>
            <div class="text-lg font-bold text-base-content">@timeAgo</div>
        </div>
    </div>

    <!-- CRITICAL: Endpoints Visited -->
    @if (Model.Paths.Count > 0)
    {
        <div class="rounded-xl border p-4 mb-4" style="border-color: var(--sb-card-border); background: var(--sb-card-bg);">
            <h3 class="text-xs font-semibold text-base-content/70 uppercase mb-2">Endpoints Visited <span class="text-base-content/40 font-normal">(@Model.Paths.Count)</span></h3>
            <div class="overflow-x-auto">
                <table class="table table-xs w-full">
                    <thead>
                        <tr class="text-[10px] uppercase tracking-wider text-base-content/40">
                            <th class="py-1">#</th>
                            <th class="py-1">Path</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (var i = 0; i < Model.Paths.Count; i++)
                        {
                            <tr class="hover:bg-base-200/50">
                                <td class="py-1 text-[10px] text-base-content/30 font-mono">@(i + 1)</td>
                                <td class="py-1 text-xs font-mono text-base-content/70">@Model.Paths[i]</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }

    <!-- CRITICAL: Recent Detections -->
    @if (Model.RecentDetections.Count > 0)
    {
        <div class="rounded-xl border p-4 mb-4" style="border-color: var(--sb-card-border); background: var(--sb-card-bg);">
            <h3 class="text-xs font-semibold text-base-content/70 uppercase mb-2">Recent Detections <span class="text-base-content/40 font-normal">(@Model.RecentDetections.Count)</span></h3>
            <div class="overflow-x-auto">
                <table class="table table-xs w-full">
                    <thead>
                        <tr class="text-[10px] uppercase tracking-wider text-base-content/40">
                            <th class="py-1">Time</th>
                            <th class="py-1">Method</th>
                            <th class="py-1">Path</th>
                            <th class="py-1 text-center">Status</th>
                            <th class="py-1 text-right">Prob</th>
                            <th class="py-1 text-right">Conf</th>
                            <th class="py-1">Risk</th>
                            <th class="py-1">Action</th>
                            <th class="py-1 text-right">Time</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var d in Model.RecentDetections)
                        {
                            var is404 = d.StatusCode == 404;
                            var statusClass = d.StatusCode >= 400 ? "text-error font-bold" : d.StatusCode >= 300 ? "text-warning" : "text-success";
                            <tr class="hover:bg-base-200/50 @(is404 ? "bg-error/5" : "")">
                                <td class="py-1 text-[10px] text-base-content/50 whitespace-nowrap">@d.Timestamp.ToString("HH:mm:ss")</td>
                                <td class="py-1 text-[10px] font-mono text-base-content/50">@d.Method</td>
                                <td class="py-1 text-xs font-mono text-base-content/70 max-w-[250px] truncate">@d.Path</td>
                                <td class="py-1 text-center text-xs @statusClass">@(d.StatusCode > 0 ? d.StatusCode.ToString() : "-")</td>
                                <td class="py-1 text-right text-xs @(d.BotProbability >= 0.7 ? "text-error" : d.BotProbability >= 0.4 ? "text-warning" : "text-success")">@($"{d.BotProbability:P0}")</td>
                                <td class="py-1 text-right text-xs text-base-content/60">@($"{d.Confidence:P0}")</td>
                                <td class="py-1 text-[10px] @RiskColor(d.RiskBand)">@d.RiskBand</td>
                                <td class="py-1 text-[10px] @ActionColor(d.Action)">@(d.Action ?? "Allow")</td>
                                <td class="py-1 text-right text-[10px] text-base-content/40 font-mono">@($"{d.ProcessingTimeMs:F1}")ms</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }

    <!-- Charts: Bot Probability & Confidence History + Processing Time -->
    @if (Model.BotProbabilityHistory.Count > 1)
    {
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
            <div class="rounded-xl border p-4" style="border-color: var(--sb-card-border); background: var(--sb-card-bg);">
                <h3 class="text-xs font-semibold text-base-content/70 uppercase mb-2">Bot Probability & Confidence History</h3>
                <div id="prob-conf-chart" style="height: 200px;"></div>
                <script type="application/json" id="prob-conf-data">@Html.Raw(System.Text.Json.JsonSerializer.Serialize(new { probability = Model.BotProbabilityHistory, confidence = Model.ConfidenceHistory }))</script>
            </div>
            <div class="rounded-xl border p-4" style="border-color: var(--sb-card-border); background: var(--sb-card-bg);">
                <h3 class="text-xs font-semibold text-base-content/70 uppercase mb-2">Processing Time History</h3>
                <div id="proc-time-chart" style="height: 200px;"></div>
                <script type="application/json" id="proc-time-data">@Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ProcessingTimeHistory))</script>
            </div>
        </div>
    }

    <!-- Two-column: Analysis + Detection Signals -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
        <div class="rounded-xl border p-4" style="border-color: var(--sb-card-border); background: var(--sb-card-bg);">
            <h3 class="text-xs font-semibold text-base-content/70 uppercase mb-2">Analysis</h3>
            @if (!string.IsNullOrEmpty(Model.Description))
            {
                <p class="text-sm text-base-content/80 mb-2">@Model.Description</p>
            }
            @if (!string.IsNullOrEmpty(Model.Narrative))
            {
                <p class="text-xs text-base-content/50 italic">@Model.Narrative</p>
            }
            @if (string.IsNullOrEmpty(Model.Description) && string.IsNullOrEmpty(Model.Narrative))
            {
                <p class="text-xs text-base-content/40 italic">No analysis available yet.</p>
            }
        </div>

        <div class="rounded-xl border p-4" style="border-color: var(--sb-card-border); background: var(--sb-card-bg);">
            <h3 class="text-xs font-semibold text-base-content/70 uppercase mb-2">Detection Signals</h3>
            @if (Model.TopReasons?.Count > 0)
            {
                <ul class="space-y-1">
                    @foreach (var reason in Model.TopReasons)
                    {
                        <li class="flex items-start gap-2 text-xs text-base-content/70">
                            <span class="text-base-content/30 mt-0.5">&#x2022;</span>
                            <span>@reason</span>
                        </li>
                    }
                </ul>
            }
            else
            {
                <p class="text-xs text-base-content/40 italic">No detection signals recorded.</p>
            }
        </div>
    </div>

    <!-- Detector Contributions -->
    @if (Model.DetectorContributions.Count > 0)
    {
        var maxContribution = Model.DetectorContributions.Max(d => Math.Abs(d.Contribution));
        <div class="rounded-xl border p-4 mb-4" style="border-color: var(--sb-card-border); background: var(--sb-card-bg);">
            <h3 class="text-xs font-semibold text-base-content/70 uppercase mb-2">Detector Contributions <span class="text-base-content/40 font-normal">(@Model.DetectorContributions.Count detectors)</span></h3>
            <div class="space-y-2">
                @foreach (var det in Model.DetectorContributions)
                {
                    var barPct = maxContribution > 0 ? (Math.Abs(det.Contribution) / maxContribution * 100) : 0;
                    var barColor = det.Contribution > 0 ? "bg-error" : "bg-success";
                    var deltaSign = det.ConfidenceDelta >= 0 ? "+" : "";
                    <div class="flex items-center gap-3">
                        <div class="w-40 text-xs font-medium text-base-content/70 truncate" title="@det.Name">@det.Name.Replace("Contributor", "")</div>
                        <div class="flex-1">
                            <div class="impact-bar">
                                <div class="impact-bar-fill @barColor" style="width: @($"{barPct:F0}")%;"></div>
                            </div>
                        </div>
                        <div class="w-16 text-right text-[10px] font-mono @(det.ConfidenceDelta > 0 ? "text-error" : "text-success")">@($"{deltaSign}{det.ConfidenceDelta:F3}")</div>
                        <div class="w-20 text-right text-[10px] text-base-content/40 font-mono">@($"{det.ExecutionTimeMs:F1}")ms</div>
                    </div>
                    @if (!string.IsNullOrEmpty(det.Reason))
                    {
                        <div class="ml-40 pl-3 text-[10px] text-base-content/40 italic -mt-1">@det.Reason</div>
                    }
                }
            </div>
        </div>
    }

    <!-- Signal Intelligence -->
    @if (Model.SignalCategories.Count > 0)
    {
        <div class="rounded-xl border p-4 mb-4" style="border-color: var(--sb-card-border); background: var(--sb-card-bg);">
            <h3 class="text-xs font-semibold text-base-content/70 uppercase mb-2">Signal Intelligence</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                @foreach (var cat in Model.SignalCategories.OrderBy(c => c.Key))
                {
                    <div>
                        <h4 class="text-[10px] font-semibold text-base-content/50 uppercase mb-1" style="color: var(--sb-accent);">@cat.Key</h4>
                        <div class="space-y-0.5">
                            @foreach (var signal in cat.Value)
                            {
                                <div class="flex items-start gap-2 text-[10px]">
                                    <span class="text-base-content/40 font-mono min-w-[80px] truncate" title="@signal.Key">@signal.Key</span>
                                    <span class="text-base-content/70 break-all">@signal.Value</span>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    @if (Model.ThreatScore.HasValue)
    {
        <div class="rounded-xl border p-4 mb-4" style="border-color: var(--sb-card-border); background: var(--sb-card-bg);">
            <h3 class="text-xs font-semibold text-base-content/70 uppercase mb-2">Threat Assessment</h3>
            <div class="flex items-center gap-4">
                @if (!string.IsNullOrEmpty(Model.BotType))
                {
                    <div>
                        <span class="text-sm text-base-content/50">Intent:</span>
                        <span class="text-sm font-bold text-base-content">@Model.BotType</span>
                    </div>
                }
                <div>
                    <span class="text-sm text-base-content/50">Score:</span>
                    <span class="text-sm font-bold @ThreatColor(Model.ThreatBand)">@($"{Model.ThreatScore:F3}")</span>
                </div>
                @if (!string.IsNullOrEmpty(Model.ThreatBand))
                {
                    <div>
                        <span class="text-sm text-base-content/50">Band:</span>
                        <span class="text-sm font-bold @ThreatColor(Model.ThreatBand)">@Model.ThreatBand</span>
                    </div>
                }
                @if (!string.IsNullOrEmpty(Model.Action))
                {
                    <div>
                        <span class="text-sm text-base-content/50">Policy:</span>
                        <span class="text-sm font-bold @ActionColor(Model.Action)">@Model.Action</span>
                    </div>
                }
            </div>
        </div>
    }

    <!-- Metadata footer -->
    <div class="text-[10px] text-base-content/30 mt-4 flex flex-wrap items-center gap-2">
        <span>Signature:</span>
        <code class="bg-base-300/50 px-1.5 py-0.5 rounded select-all">@Model.SignatureId</code>
        <span class="text-base-content/20">|</span>
        <span>Processing: @($"{Model.ProcessingTimeMs:F1}")ms</span>
        @if (!string.IsNullOrEmpty(Model.CountryCode) && Model.CountryCode != "XX")
        {
            <span class="text-base-content/20">|</span>
            <span>Country: @Model.CountryCode</span>
        }
        @if (!string.IsNullOrEmpty(Model.UserAgent))
        {
            <span class="text-base-content/20">|</span>
            <span class="max-w-[400px] truncate" title="@Model.UserAgent">UA: @Model.UserAgent</span>
        }
        @if (!string.IsNullOrEmpty(Model.Protocol))
        {
            <span class="text-base-content/20">|</span>
            <span>Protocol: @Model.Protocol</span>
        }
        @if (Model.FirstSeen != default)
        {
            <span class="text-base-content/20">|</span>
            <span>First seen: @Model.FirstSeen.ToString("yyyy-MM-dd HH:mm:ss") UTC</span>
        }
    </div>
}

    </main>

    <!-- ApexCharts rendering -->
    @if (Model.Found && Model.BotProbabilityHistory.Count > 1)
    {
        <script nonce="@Model.CspNonce">
        (function() {
            var isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            var fg = isDark ? '#94a3b8' : '#475569';
            var gridColor = isDark ? 'rgba(148,163,184,0.1)' : 'rgba(15,23,42,0.08)';

            // Bot Probability & Confidence chart
            var pcData = JSON.parse(document.getElementById('prob-conf-data').textContent);
            if (pcData.probability && pcData.probability.length > 1) {
                new ApexCharts(document.getElementById('prob-conf-chart'), {
                    chart: { type: 'line', height: 200, background: 'transparent', toolbar: { show: false }, animations: { enabled: false } },
                    series: [
                        { name: 'Bot Probability', data: pcData.probability },
                        { name: 'Confidence', data: pcData.confidence }
                    ],
                    colors: ['#ef4444', '#5ba3a3'],
                    stroke: { width: 2, curve: 'smooth' },
                    xaxis: { labels: { show: false }, axisBorder: { show: false }, axisTicks: { show: false } },
                    yaxis: { min: 0, max: 1, labels: { style: { colors: fg, fontSize: '10px' }, formatter: function(v) { return (v * 100).toFixed(0) + '%'; } } },
                    grid: { borderColor: gridColor, strokeDashArray: 3 },
                    legend: { position: 'top', fontSize: '10px', labels: { colors: fg } },
                    tooltip: { theme: isDark ? 'dark' : 'light', y: { formatter: function(v) { return (v * 100).toFixed(1) + '%'; } } }
                }).render();
            }

            // Processing Time chart
            var ptData = JSON.parse(document.getElementById('proc-time-data').textContent);
            if (ptData && ptData.length > 1) {
                new ApexCharts(document.getElementById('proc-time-chart'), {
                    chart: { type: 'area', height: 200, background: 'transparent', toolbar: { show: false }, animations: { enabled: false } },
                    series: [{ name: 'Processing Time (ms)', data: ptData }],
                    colors: ['#daa564'],
                    stroke: { width: 2, curve: 'smooth' },
                    fill: { type: 'gradient', gradient: { opacityFrom: 0.3, opacityTo: 0.05 } },
                    xaxis: { labels: { show: false }, axisBorder: { show: false }, axisTicks: { show: false } },
                    yaxis: { logarithmic: true, labels: { style: { colors: fg, fontSize: '10px' }, formatter: function(v) { return v < 1 ? v.toFixed(2) + 'ms' : v.toFixed(0) + 'ms'; } } },
                    grid: { borderColor: gridColor, strokeDashArray: 3 },
                    legend: { show: false },
                    tooltip: { theme: isDark ? 'dark' : 'light', y: { formatter: function(v) { return v.toFixed(2) + 'ms'; } } }
                }).render();
            }
        })();
        </script>
    }

    <!-- SignalR beacon: auto-refresh when this signature is updated -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js" nonce="@Model.CspNonce"></script>
    <script nonce="@Model.CspNonce">
    (function() {
        var sigId = '@Html.Raw(Model.SignatureId.Replace("'", "\\'"))';
        var hubPath = '@Html.Raw(Model.HubPath)';
        var conn = new signalR.HubConnectionBuilder()
            .withUrl(hubPath)
            .withAutomaticReconnect([0, 2000, 5000, 10000])
            .build();

        conn.on('invalidated', function(keys) {
            if (!keys || !Array.isArray(keys)) return;
            // Refresh if this signature or 'summary' is invalidated
            for (var i = 0; i < keys.length; i++) {
                if (keys[i] === sigId || keys[i] === 'summary' || keys[i] === 'signature') {
                    window.location.reload();
                    return;
                }
            }
        });

        conn.start().catch(function(err) {
            console.debug('SignalR connection failed for signature detail:', err);
        });
    })();
    </script>
</body>
</html>
