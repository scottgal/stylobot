@using Mostlylucid.BotDetection.UI.Models
@model DashboardShellModel
@{
    Layout = null;
    var bp = Model.BasePath;
    var tab = Model.ActiveTab;
    string TabUrl(string t) => $"{bp}?tab={t}";
    string TabClass(string t) => tab == t
        ? "bg-base-100 shadow-sm text-base-content font-semibold"
        : "text-base-content/40 hover:text-base-content/60";
}
<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>StyloBot Detection Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daisyui@@4.6.0/dist/full.min.css" />
    <script src="https://cdn.tailwindcss.com" nonce="@Model.CspNonce"></script>
    <script src="https://unpkg.com/htmx.org@@2.0.4" nonce="@Model.CspNonce"></script>
    <script src="https://cdn.jsdelivr.net/npm/@@microsoft/signalr@@8.0.0/dist/browser/signalr.min.js" nonce="@Model.CspNonce"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@@3.13.5/dist/cdn.min.js" nonce="@Model.CspNonce"></script>
    <link rel="stylesheet" href="https://unpkg.com/boxicons@@2.1.4/css/boxicons.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Raleway:wght@700;800;900&display=swap" rel="stylesheet" />

    <script nonce="@Model.CspNonce">
        (function() {
            try {
                var saved = localStorage.getItem('sb-theme');
                if (saved) document.documentElement.setAttribute('data-theme', saved);
                else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches)
                    document.documentElement.setAttribute('data-theme', 'light');
            } catch(e) {}
            if (new URLSearchParams(window.location.search).get('embed') === '1') {
                document.addEventListener('DOMContentLoaded', function() {
                    var hdr = document.getElementById('sb-brand-header');
                    if (hdr) hdr.style.display = 'none';
                });
            }
        })();
    </script>

    <style nonce="@Model.CspNonce">
        [x-cloak] { display: none !important; }
        [data-theme="dark"] {
            --sb-brand-muted: #6b7280;
            --sb-brand-strong: #ffffff;
            --sb-accent: #5ba3a3;
            --sb-accent-alt: #0f4c81;
            --sb-accent-strong: #86b59c;
            --sb-surface: #0b1220;
            --sb-card-bg: #141f33;
            --sb-card-border: rgba(91, 163, 163, 0.28);
            --sb-card-divider: rgba(148, 163, 184, 0.18);
            --sb-card-subtle: #334155;
            --sb-signal-pos: #86B59C;
            --sb-signal-warn: #DAA564;
            --sb-signal-danger: #ef4444;
        }
        [data-theme="light"] {
            --sb-brand-muted: #475569;
            --sb-brand-strong: #0f172a;
            --sb-accent: #0f766e;
            --sb-accent-alt: #0f4c81;
            --sb-accent-strong: #059669;
            --sb-surface: #f8fafc;
            --sb-card-bg: #ffffff;
            --sb-card-border: rgba(15, 118, 110, 0.18);
            --sb-card-divider: rgba(15, 23, 42, 0.1);
            --sb-card-subtle: #94a3b8;
            --sb-signal-pos: #16a34a;
            --sb-signal-warn: #d97706;
            --sb-signal-danger: #dc2626;
        }

        body { font-family: 'Inter', sans-serif; background: var(--sb-surface); }
        .brand-header {
            background: linear-gradient(120deg, color-mix(in oklab, var(--sb-surface) 78%, #0f172a), color-mix(in oklab, var(--sb-card-bg) 70%, #0f172a));
            border-bottom: 1px solid var(--sb-card-divider);
        }
        .sb-link { color: var(--sb-accent); text-decoration: none; }
        .sb-link:hover { text-decoration: underline; }

        /* HTMX transition styles */
        .htmx-swapping { opacity: 0; transition: opacity 200ms ease-out; }
        .htmx-settling { opacity: 1; transition: opacity 200ms ease-in; }
        .htmx-added { opacity: 0; }
        .htmx-added.htmx-settling { opacity: 1; transition: opacity 300ms ease-in; }

        /* Connection status indicator */
        .sb-connected { background: var(--sb-signal-pos); }
        .sb-disconnected { background: var(--sb-signal-danger); }
        .sb-connecting { background: var(--sb-signal-warn); animation: pulse 1.5s infinite; }
        @@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    </style>
</head>
<body class="min-h-screen" hx-headers='{"X-Requested-With": "XMLHttpRequest"}'>

    <!-- Brand header -->
    <header id="sb-brand-header" class="brand-header px-4 py-3">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
                <a href="@bp" class="text-lg font-black tracking-tight" style="color: var(--sb-accent);">
                    <span style="font-family: 'Raleway', sans-serif;">StyloBot</span>
                </a>
                <span class="text-xs font-medium px-2 py-0.5 rounded-full"
                      style="background: var(--sb-card-bg); color: var(--sb-brand-muted); border: 1px solid var(--sb-card-border);">
                    Dashboard
                </span>
                <!-- SignalR connection status -->
                <span id="sb-connection-status" class="w-2 h-2 rounded-full sb-disconnected" title="SignalR: disconnected"></span>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="document.documentElement.setAttribute('data-theme', document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'); try { localStorage.setItem('sb-theme', document.documentElement.getAttribute('data-theme')); } catch(e) {}"
                        class="btn btn-ghost btn-xs btn-circle">
                    <i class="bx bx-moon text-sm"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main content -->
    <main class="max-w-7xl mx-auto px-4 py-4">

        <!-- Summary stats — always visible -->
        @await Html.PartialAsync("~/Views/Dashboard/_SummaryStats.cshtml", Model.Summary)

        <!-- Tab navigation -->
        <div class="flex items-center gap-1 my-4 bg-base-300/50 rounded-lg p-0.5 w-fit">
            <a href="@TabUrl("overview")" class="px-3 py-1.5 text-xs font-medium rounded-md transition-all @TabClass("overview")">Overview</a>
            <a href="@TabUrl("visitors")" class="px-3 py-1.5 text-xs font-medium rounded-md transition-all @TabClass("visitors")">Visitors</a>
            <a href="@TabUrl("countries")" class="px-3 py-1.5 text-xs font-medium rounded-md transition-all @TabClass("countries")">Countries</a>
            <a href="@TabUrl("clusters")" class="px-3 py-1.5 text-xs font-medium rounded-md transition-all @TabClass("clusters")">Clusters</a>
            <a href="@TabUrl("useragents")" class="px-3 py-1.5 text-xs font-medium rounded-md transition-all @TabClass("useragents")">User Agents</a>
        </div>

        @if (tab == "overview")
        {
            <!-- Overview: two-column layout -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                <!-- Left: Visitor feed -->
                <div class="lg:col-span-2">
                    @await Html.PartialAsync("~/Views/Dashboard/_VisitorList.cshtml", Model.Visitors)
                </div>
                <!-- Right: sidebar widgets -->
                <div class="space-y-4">
                    @await Html.PartialAsync("~/Views/Dashboard/_YourDetection.cshtml", Model.YourDetection)
                    @await Html.PartialAsync("~/Views/Dashboard/_CountriesList.cshtml", Model.Countries)
                </div>
            </div>
        }
        else if (tab == "visitors")
        {
            @await Html.PartialAsync("~/Views/Dashboard/_VisitorList.cshtml", Model.Visitors)
        }
        else if (tab == "countries")
        {
            @await Html.PartialAsync("~/Views/Dashboard/_CountriesList.cshtml", Model.Countries)
        }
        else if (tab == "clusters")
        {
            @await Html.PartialAsync("~/Views/Dashboard/_ClustersList.cshtml", Model.Clusters)
        }
        else if (tab == "useragents")
        {
            @await Html.PartialAsync("~/Views/Dashboard/_UserAgentsList.cshtml", Model.UserAgents)
        }

    </main>

    <!-- SignalR → HTMX coordinator (the entire client-side JS) -->
    <script nonce="@Model.CspNonce">
    (function() {
        'use strict';

        var BASE = '@Html.Raw(bp)';
        var HUB  = '@Html.Raw(Model.HubPath)';

        // ── Widget registry ──────────────────────────────────────────────
        // Discovers all widgets on the page via data-sb-widget / data-sb-depends.
        // Each widget declares what SignalR signals it cares about.
        function getWidgetMap() {
            var map = {};  // signal → [widgetId, ...]
            document.querySelectorAll('[data-sb-widget]').forEach(function(el) {
                var deps = (el.getAttribute('data-sb-depends') || '').split(',');
                deps.forEach(function(dep) {
                    dep = dep.trim();
                    if (!dep) return;
                    if (!map[dep]) map[dep] = [];
                    var wid = el.getAttribute('data-sb-widget');
                    if (map[dep].indexOf(wid) === -1) map[dep].push(wid);
                });
            });
            return map;
        }

        // ── Debounced OOB updater ────────────────────────────────────────
        // Collects widget IDs that need updating, then fires a single
        // HTMX request to the OOB endpoint after a short debounce.
        var pending = {};
        var debounceTimer = null;
        var DEBOUNCE_MS = 500;

        function invalidate(signal) {
            var widgetMap = getWidgetMap();
            var widgets = widgetMap[signal] || [];
            widgets.forEach(function(w) { pending[w] = true; });

            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(flush, DEBOUNCE_MS);
        }

        function flush() {
            var ids = Object.keys(pending);
            if (ids.length === 0) return;
            pending = {};

            // Build the OOB update URL with current filter/sort state from the visitor list
            var url = BASE + '/partials/update?widgets=' + ids.join(',');

            // Preserve visitor list state if visitors are being updated
            if (ids.indexOf('visitors') !== -1) {
                var vl = document.getElementById('visitor-list');
                if (vl) {
                    var params = new URLSearchParams();
                    // Read current state from the last HTMX request or from filter buttons
                    var activeFilter = vl.querySelector('.bg-error\\/20, .bg-success\\/20, .shadow-sm');
                    // Just use defaults — server will return the default view
                }
            }

            // Use htmx.ajax to make the request; the server returns OOB fragments
            if (typeof htmx !== 'undefined') {
                htmx.ajax('GET', url, { target: 'body', swap: 'none' });
            }
        }

        // ── SignalR connection ────────────────────────────────────────────
        var statusEl = document.getElementById('sb-connection-status');

        function setStatus(state) {
            if (!statusEl) return;
            statusEl.className = 'w-2 h-2 rounded-full sb-' + state;
            statusEl.title = 'SignalR: ' + state;
        }

        var connection = new signalR.HubConnectionBuilder()
            .withUrl(HUB)
            .withAutomaticReconnect([0, 1000, 2000, 5000, 10000, 30000])
            .configureLogging(signalR.LogLevel.Warning)
            .build();

        // Map SignalR events to invalidation signals
        connection.on('BroadcastInvalidation', function(signal) { if (signal) invalidate(signal); });
        connection.on('BroadcastSummary',    function() { invalidate('summary'); });
        connection.on('BroadcastTopBots',    function() { invalidate('signature'); invalidate('summary'); });
        connection.on('BroadcastSignature',  function(sig) {
            invalidate('signature');
            // Also invalidate the specific signature (for "Your Detection" widget)
            if (sig && sig.primarySignature) invalidate(sig.primarySignature);
        });
        connection.on('BroadcastDetection',  function(det) {
            invalidate('signature');
            invalidate('summary');
            if (det && det.primarySignature) invalidate(det.primarySignature);
        });
        connection.on('BroadcastCountries',  function() { invalidate('countries'); });
        connection.on('BroadcastClusters',   function() { invalidate('clusters'); });
        connection.on('BroadcastDescriptionUpdate', function() { invalidate('signature'); });
        connection.on('BroadcastSignatureDescriptionUpdate', function(sig) {
            invalidate('signature');
            if (sig) invalidate(sig);
        });
        connection.on('BroadcastClusterDescriptionUpdate', function() { invalidate('clusters'); });
        connection.on('BroadcastScoreNarrative', function(sig) {
            if (sig) invalidate(sig);
        });

        connection.onreconnecting(function() { setStatus('connecting'); });
        connection.onreconnected(function()  { setStatus('connected'); });
        connection.onclose(function()        { setStatus('disconnected'); });

        connection.start()
            .then(function()  { setStatus('connected'); })
            .catch(function() { setStatus('disconnected'); });
    })();
    </script>
</body>
</html>
