@using Mostlylucid.BotDetection.UI.Models
@model TopBotsListModel
@{
    var bp = Model.BasePath;
    string SortUrl(string field) => $"{bp}/partials/topbots?sort={field}&page=1&pageSize={Model.PageSize}";
    string PageUrl(int page) => $"{bp}/partials/topbots?sort={Model.SortField}&page={page}&pageSize={Model.PageSize}";
    string SortIcon(string field) => Model.SortField == field ? " \u25BC" : "";
    string ThClass(string field) => Model.SortField == field
        ? "text-base-content/70 font-bold"
        : "text-base-content/40 hover:text-base-content/60";

    static bool HasFlag(string? code) => !string.IsNullOrEmpty(code) && code.Length == 2 && code != "XX";
    static string FlagUrl(string code) => $"https://flagcdn.com/w40/{code.ToLowerInvariant()}.png";
}
<div id="topbots-list"
     data-sb-widget="topbots"
     data-sb-depends="signature,summary"
     class="card bg-base-200 transition-all duration-200">
    <div class="card-body p-3">
        <h3 class="text-sm font-bold text-base-content mb-1">Top Bots</h3>

        @if (Model.Bots.Count == 0)
        {
            <div class="text-xs text-base-content/40 py-4 text-center">No bots detected yet</div>
        }
        else
        {
            <div class="overflow-x-auto">
                <table class="table table-xs w-full">
                    <thead>
                        <tr class="text-[10px] uppercase tracking-wider">
                            <th class="py-1 w-6"></th>
                            <th class="py-1 @ThClass("name") cursor-pointer"
                                hx-get="@SortUrl("name")" hx-target="#topbots-list" hx-swap="outerHTML transition:true">
                                Name@(Html.Raw(SortIcon("name")))
                            </th>
                            <th class="py-1 text-center @ThClass("threat")">Threat</th>
                            <th class="py-1 text-right @ThClass("probability") cursor-pointer"
                                hx-get="@SortUrl("probability")" hx-target="#topbots-list" hx-swap="outerHTML transition:true">
                                Prob@(Html.Raw(SortIcon("probability")))
                            </th>
                            <th class="py-1 text-right @ThClass("hits") cursor-pointer"
                                hx-get="@SortUrl("hits")" hx-target="#topbots-list" hx-swap="outerHTML transition:true">
                                Hits@(Html.Raw(SortIcon("hits")))
                            </th>
                            <th class="py-1 text-right @ThClass("lastseen") cursor-pointer"
                                hx-get="@SortUrl("lastseen")" hx-target="#topbots-list" hx-swap="outerHTML transition:true">
                                Seen@(Html.Raw(SortIcon("lastseen")))
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var bot in Model.Bots)
                        {
                            var riskClass = bot.RiskBand switch {
                                "VeryHigh" or "High" => "text-error",
                                "Medium" or "Elevated" => "text-warning",
                                _ => "text-success"
                            };
                            var threatClass = bot.ThreatBand switch {
                                "Critical" or "High" => "text-error",
                                "Medium" => "text-warning",
                                _ => ""
                            };
                            var displayName = bot.BotName ?? bot.BotType ?? "Unknown";
                            var probPct = (bot.BotProbability * 100).ToString("F0");
                            <tr class="hover:bg-base-300/50 cursor-pointer transition-colors">
                                <td class="py-1 w-6">
                                    <a href="@bp/signature/@Uri.EscapeDataString(bot.PrimarySignature)" class="block">
                                    @if (HasFlag(bot.CountryCode))
                                    {
                                        <img src="@FlagUrl(bot.CountryCode!)" alt="@bot.CountryCode" class="w-6 h-4 object-cover rounded-sm" loading="lazy" />
                                    }
                                    else
                                    {
                                        <span class="text-base-content/30 text-[10px]">--</span>
                                    }
                                    </a>
                                </td>
                                <td class="py-1 font-medium text-xs truncate max-w-[140px]" title="@displayName">
                                    <a href="@bp/signature/@Uri.EscapeDataString(bot.PrimarySignature)" class="hover:underline">@displayName</a>
                                </td>
                                <td class="py-1 text-center">
                                    @if (!string.IsNullOrEmpty(bot.ThreatBand) && bot.ThreatBand != "None")
                                    {
                                        <span class="text-[10px] font-semibold @threatClass">@bot.ThreatBand</span>
                                    }
                                </td>
                                <td class="py-1 text-right font-bold text-xs @riskClass">@(probPct)%</td>
                                <td class="py-1 text-right text-xs text-base-content/60 font-mono">@bot.HitCount</td>
                                <td class="py-1 text-right text-[10px] text-base-content/40">@bot.TimeAgo</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            @* Pagination *@
            @if (Model.TotalPages > 1)
            {
                <div class="flex items-center justify-between mt-2 pt-2 border-t border-base-300">
                    <span class="text-[10px] text-base-content/40">@Model.Page/@Model.TotalPages (@Model.TotalCount bots)</span>
                    <div class="join">
                        @if (Model.Page > 1)
                        {
                            <button hx-get="@PageUrl(1)" hx-target="#topbots-list" hx-swap="outerHTML transition:true"
                                    class="join-item btn btn-xs" title="First">&laquo;</button>
                            <button hx-get="@PageUrl(Model.Page - 1)" hx-target="#topbots-list" hx-swap="outerHTML transition:true"
                                    class="join-item btn btn-xs" title="Previous">&lsaquo;</button>
                        }
                        @for (var p = Math.Max(1, Model.Page - 2); p <= Math.Min(Model.TotalPages, Model.Page + 2); p++)
                        {
                            var pageNum = p;
                            <button hx-get="@PageUrl(pageNum)" hx-target="#topbots-list" hx-swap="outerHTML transition:true"
                                    class="join-item btn btn-xs @(pageNum == Model.Page ? "btn-active" : "")">@pageNum</button>
                        }
                        @if (Model.Page < Model.TotalPages)
                        {
                            <button hx-get="@PageUrl(Model.Page + 1)" hx-target="#topbots-list" hx-swap="outerHTML transition:true"
                                    class="join-item btn btn-xs" title="Next">&rsaquo;</button>
                            <button hx-get="@PageUrl(Model.TotalPages)" hx-target="#topbots-list" hx-swap="outerHTML transition:true"
                                    class="join-item btn btn-xs" title="Last">&raquo;</button>
                        }
                    </div>
                </div>
            }
        }
    </div>
</div>
