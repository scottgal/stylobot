{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://botdetection.dev/schemas/policy.schema.json",
  "title": "BotDetection Policy",
  "description": "Schema for BotDetection policy files (*.policies.yaml)",
  "type": "object",
  "required": ["policies"],
  "properties": {
    "policies": {
      "type": "object",
      "description": "Map of policy definitions keyed by policy name",
      "additionalProperties": {
        "$ref": "#/$defs/policy"
      }
    }
  },
  "$defs": {
    "policy": {
      "type": "object",
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "description": "Policy type",
          "enum": ["Block", "Throttle", "Challenge", "Redirect", "LogOnly"]
        },
        "extends": {
          "type": "string",
          "description": "Parent policy to inherit from"
        },
        "description": {
          "type": "string",
          "description": "Human-readable description"
        },
        "tags": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Tags for categorization and filtering"
        }
      },
      "allOf": [
        {
          "if": {
            "properties": {"type": {"const": "Block"}}
          },
          "then": {
            "$ref": "#/$defs/blockPolicy"
          }
        },
        {
          "if": {
            "properties": {"type": {"const": "Throttle"}}
          },
          "then": {
            "$ref": "#/$defs/throttlePolicy"
          }
        },
        {
          "if": {
            "properties": {"type": {"const": "Challenge"}}
          },
          "then": {
            "$ref": "#/$defs/challengePolicy"
          }
        },
        {
          "if": {
            "properties": {"type": {"const": "Redirect"}}
          },
          "then": {
            "$ref": "#/$defs/redirectPolicy"
          }
        },
        {
          "if": {
            "properties": {"type": {"const": "LogOnly"}}
          },
          "then": {
            "$ref": "#/$defs/logOnlyPolicy"
          }
        }
      ]
    },
    "blockPolicy": {
      "type": "object",
      "properties": {
        "status_code": {
          "type": "integer",
          "description": "HTTP status code to return",
          "enum": [403, 429, 503],
          "default": 403
        },
        "message": {
          "type": "string",
          "description": "Response message"
        },
        "content_type": {
          "type": "string",
          "description": "Response content type",
          "default": "text/plain"
        },
        "add_headers": {
          "type": "object",
          "description": "Additional headers to add",
          "additionalProperties": {"type": "string"}
        },
        "log_level": {
          "type": "string",
          "enum": ["Debug", "Information", "Warning", "Error"],
          "default": "Warning"
        }
      }
    },
    "throttlePolicy": {
      "type": "object",
      "properties": {
        "delay_ms": {
          "type": "integer",
          "description": "Base delay in milliseconds",
          "minimum": 0,
          "default": 1000
        },
        "max_delay_ms": {
          "type": "integer",
          "description": "Maximum delay in milliseconds",
          "minimum": 0,
          "default": 10000
        },
        "adaptive": {
          "type": "boolean",
          "description": "Whether to adapt delay based on bot score",
          "default": true
        },
        "jitter_percent": {
          "type": "number",
          "description": "Random jitter percentage (0-100)",
          "minimum": 0,
          "maximum": 100,
          "default": 10
        },
        "track_pattern": {
          "type": "boolean",
          "description": "Whether to track throttled patterns",
          "default": true
        },
        "escalate_threshold": {
          "type": "integer",
          "description": "Number of throttles before escalating to block",
          "minimum": 1
        }
      }
    },
    "challengePolicy": {
      "type": "object",
      "properties": {
        "challenge_type": {
          "type": "string",
          "description": "Type of challenge to present",
          "enum": ["javascript", "captcha", "proof_of_work", "cookie"],
          "default": "javascript"
        },
        "difficulty": {
          "type": "string",
          "description": "Challenge difficulty",
          "enum": ["easy", "medium", "hard"],
          "default": "medium"
        },
        "timeout_seconds": {
          "type": "integer",
          "description": "Challenge timeout",
          "minimum": 1,
          "default": 60
        },
        "max_attempts": {
          "type": "integer",
          "description": "Maximum challenge attempts before blocking",
          "minimum": 1,
          "default": 3
        },
        "success_cookie": {
          "type": "string",
          "description": "Cookie to set on successful challenge"
        },
        "success_cookie_duration_hours": {
          "type": "integer",
          "description": "How long the success cookie is valid",
          "minimum": 1,
          "default": 24
        }
      }
    },
    "redirectPolicy": {
      "type": "object",
      "properties": {
        "target_url": {
          "type": "string",
          "description": "URL to redirect to",
          "format": "uri-reference"
        },
        "permanent": {
          "type": "boolean",
          "description": "Whether to use permanent redirect (301 vs 302)",
          "default": false
        },
        "preserve_query_string": {
          "type": "boolean",
          "description": "Whether to preserve the original query string",
          "default": false
        },
        "include_return_url": {
          "type": "boolean",
          "description": "Whether to include original URL as return_url parameter",
          "default": false
        },
        "return_url_param": {
          "type": "string",
          "description": "Parameter name for return URL",
          "default": "returnUrl"
        },
        "add_metadata": {
          "type": "boolean",
          "description": "Whether to add detection metadata to redirect",
          "default": false
        }
      }
    },
    "logOnlyPolicy": {
      "type": "object",
      "properties": {
        "log_level": {
          "type": "string",
          "enum": ["Debug", "Information", "Warning", "Error"],
          "default": "Information"
        },
        "log_full_evidence": {
          "type": "boolean",
          "description": "Whether to log full detection evidence",
          "default": false
        },
        "add_response_headers": {
          "type": "boolean",
          "description": "Whether to add detection headers to response",
          "default": false
        },
        "include_detailed_headers": {
          "type": "boolean",
          "description": "Whether to include detailed per-detector headers",
          "default": false
        },
        "add_to_context_items": {
          "type": "boolean",
          "description": "Whether to add detection result to HttpContext.Items",
          "default": true
        },
        "would_block_threshold": {
          "type": "number",
          "description": "Score threshold that would trigger a block",
          "minimum": 0,
          "maximum": 1,
          "default": 0.85
        },
        "forward_url": {
          "type": "string",
          "description": "URL to forward detection events to",
          "format": "uri"
        },
        "forward_async": {
          "type": "boolean",
          "description": "Whether to forward asynchronously",
          "default": true
        }
      }
    }
  }
}
