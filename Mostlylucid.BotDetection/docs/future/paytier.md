# Stylobot Detection Service – Free vs Enterprise Specification

## 1. Goals & Principles

* **Single core engine**
  One detection core (Ephemeral + detectors) shared by all editions.

* **Tiering by capability, not truth**
  All tiers:

    * receive **full score vectors** for the detectors they have access to.
    * see the same basic objects: requests → detections → scores.

* **Edge-first, local-only by default**

    * No mandatory cloud calls.
    * All detectors, including “premium” ones, can run locally.

* **Config is real**

    * Free users configure everything via **files**.
    * Enterprise users get a **control plane** on top of the same config model.

* **Premium = more detectors, not different semantics**

    * Enterprise users get **additional detector families** (“premium detectors”).
    * These simply add more `detectorScores` entries to the response.

---

## 2. Editions Overview

### 2.1. Stylobot Free

**Audience:** blogs, side projects, small sites, local installs.

**Transport:**

* REST API only.
* SignalR hub for live stats (read-only).

**Detectors:**

* **Base detectors only**, e.g.:

    * `FastPathReputation`
    * `Heuristic`
    * `UserAgent`
    * `Ip`
    * `Header`
    * `Behavioral`
    * `VersionAge`
* No premium / expensive detectors.

**Config & tuning:**

* All tuning via **local config files** (YAML/JSON).
* No write APIs.
* Can send thumbs-up / thumbs-down on signatures (feedback only).

**Live views:**

* SignalR:

    * basic summary stats,
    * top signatures,
    * risk band distribution.
* PII-scrubbed, aggregate only.

---

### 2.2. Stylobot Enterprise

**Audience:** high-traffic sites, gateways, security / SOC teams.

**Transport:**

* REST (same as Free) + **gRPC gateway**:

    * High-volume detection (`Detect`, `StreamDecisions`).
    * Admin/control (`PolicyAdmin`, `SignatureAdmin`).
* SignalR hub for live stats (richer views, tenant-scoped).

**Detectors:**

* All base detectors **plus** **premium detectors**, e.g.:

    * `PremiumReputation` (paid feeds)
    * `DeepBehavioral`
    * `ClientFingerprint`
    * `ContentHeuristic`
    * `Llm` / AI-based detectors
* Premium detectors add **extra scores** in `detectorScores`.

**Config & tuning:**

* Same underlying config model as Free.
* Extended via:

    * gRPC admin services,
    * web UI on top of those services.
* Per-tenant overrides:

    * enable/disable detectors,
    * bounded weight tweaks,
    * per-signature risk bias.

**Live views:**

* Same SignalR hub, but:

    * can subscribe to tenant-specific streams,
    * richer stats (per-endpoint, per-signature, per-detector contributions),
    * optional AI explanations (local).

---

## 3. Core Domain Model

These types are conceptually shared across all transports.

### 3.1. DetectionRequest

Logical shape (independent of REST/gRPC encoding):

```csharp
public sealed record DetectionRequest(
    string RequestId,
    string TenantId,        // optional for single-tenant
    string Protocol,        // "http", "ssh", "tcp", "ws", ...
    string IpAddress,
    int?   Port,
    string? Method,         // HTTP: "GET","POST", ...
    string? Path,           // HTTP path
    IReadOnlyDictionary<string, string> Headers,
    DetectionContext Context // see below
);
```

`DetectionContext` is a PII-safe feature bag:

```csharp
public sealed record DetectionContext(
    string? UserAgentFamily,
    string? Country,
    string? Asn,
    int?    FailureCountLastMinute,
    int?    RequestsLastMinute,
    IReadOnlyDictionary<string, string> Extra
);
```

### 3.2. DetectorScore

Each detector contributes a score and weight:

```csharp
public sealed record DetectorScore(
    string Name,        // e.g. "Behavioral", "PremiumReputation"
    double Score,       // contribution (positive bot, negative human, etc.)
    double Weight,      // policy weight
    string? Notes = null
);
```

* **Free edition**: `Name` is always in the **base detector set**.
* **Enterprise**: includes base **and** premium detectors.

### 3.3. DetectionResult

Returned by all tiers:

```csharp
public sealed record DetectionResult(
    string DetectionId,
    string Policy,
    bool   IsBot,
    bool   IsHuman,
    double HumanProbability,
    double BotProbability,
    string RiskBand,        // "VeryLow","Low","Medium","High","VeryHigh"
    string RecommendedAction, // "Allow","Challenge","Block","Honeypot"
    IReadOnlyList<DetectorScore> DetectorScores,
    DetectionContext Features
);
```

For **both** Free and Enterprise:

* `DetectorScores` contains **all detectors active for that edition**.
* There is no “hidden” score in Enterprise; it just has **more detectors**.

### 3.4. Optional AI Explanation (Enterprise only)

Generated by a **local** AI explainer, not required for detection:

```csharp
public sealed record AiExplanation(
    string DetectionId,
    string Summary,
    IReadOnlyList<string> KeyFactors,
    string? Recommendation
);
```

* Not guaranteed to be present in the immediate detection response.
* May be fetched via a separate endpoint or stream once computed.

---

## 4. Transport APIs

### 4.1. REST API (Free + Enterprise)

#### 4.1.1. POST `/api/detect`

**Request body:** logical `DetectionRequest` as JSON (subset + PII-safe fields).

**Response:** `DetectionResult` as JSON.

* Free: only base detectors enabled → fewer `detectorScores` entries.
* Enterprise: base + premium detectors → more `detectorScores`.

#### 4.1.2. POST `/api/feedback/signature` (All tiers)

```json
{
  "detectionId": "abc-123",
  "signatureId": "S-12345",
  "vote": "up"      // or "down"
}
```

* Recorded for quality / training.
* Does **not** directly change live config.

#### 4.1.3. GET `/api/signatures` (All tiers)

Query parameters:

* `q` – free-text search
* `risk` – filter by risk band
* `since` – filter by time window
* `sort` – e.g. `volume`, `risk`, `recent`

Response (simplified):

```json
[
  {
    "id": "S-12345",
    "name": "Credential stuffing on login",
    "description": "Multiple failed logins from same IP in short window",
    "riskBand": "High",
    "eventsLastHour": 120,
    "blockRate": 0.85
  }
]
```

#### 4.1.4. GET `/api/signatures/{id}` (All tiers)

Returns detail, still **read-only**:

* signature metadata
* associated detectors (names only)
* aggregated stats.

No raw weights exposed to REST.

---

### 4.2. gRPC API (Enterprise only)

Namespace suggestion: `stylobot.v1`.

#### 4.2.1. Data-plane service: `StylobotGateway`

```proto
service StylobotGateway {
  rpc Detect          (DetectRequest)  returns (DetectResponse);
  rpc StreamDecisions (stream DetectRequest)
                       returns (stream DetectResponse);
}
```

* `DetectRequest` / `DetectResponse` mirror `DetectionRequest` / `DetectionResult`.
* `DetectResponse` may include an `AiExplanation` field or a reference to fetch later.

#### 4.2.2. Control-plane services (Enterprise)

**Policy administration:**

```proto
service PolicyAdmin {
  rpc GetPolicy    (GetPolicyRequest)    returns (Policy);
  rpc UpdatePolicy (UpdatePolicyRequest) returns (Policy);

  rpc ListSignatures (ListSignaturesRequest)
                      returns (ListSignaturesResponse);
  rpc GetSignature   (GetSignatureRequest)
                      returns (Signature);

  rpc CreateOverride (CreateOverrideRequest)
                      returns (SignatureOverride);
  rpc UpdateOverride (UpdateOverrideRequest)
                      returns (SignatureOverride);
}
```

Key types:

```proto
message SignatureOverride {
  string tenant_id    = 1;
  string signature_id = 2;

  string risk_bias    = 3; // e.g. "minus1", "plus1"

  // Bounded tweaks: [0.5x, 2x]
  map<string,double> detector_weight_scale = 4;

  bool disabled = 5;
}
```

* Enterprise uses this to **manually** tune behaviour.
* Free never calls these; it relies on config files only.

---

### 4.3. SignalR (All tiers, different views)

Single hub, e.g. `StylobotStatsHub`.

**Common streams:**

* `SummaryUpdated(SummarySnapshot)`
* `SignaturesUpdated(SignatureSummary[])`

`SummarySnapshot` might include:

```csharp
public sealed record SummarySnapshot(
    DateTimeOffset Timestamp,
    int RequestsLast10s,
    int BotsLast10s,
    int HumansLast10s,
    int BlockedLast10s,
    int ChallengedLast10s
);
```

**Enterprise-only extras:**

* Per-tenant streams:

    * `TenantSummaryUpdated(tenantId, SummarySnapshot)`
    * `SignatureDetailUpdated(SignatureDetail)`
* Optional explanation stream:

    * `ExplanationReady(AiExplanation)`

Authorization decides which methods/groups a connection can join.

---

## 5. Detectors & Premium Detectors

### 5.1. Base Detectors (All tiers)

Example base set:

* `FastPathReputation`
* `SecurityTool` (simple known tool UA / patterns)
* `UserAgent`
* `Ip`
* `Header`
* `Behavioral`
* `VersionAge`
* `Heuristic`
* `HeuristicLate`

Available in:

* Free (via config files),
* Enterprise (plus more).

### 5.2. Premium Detectors (Enterprise only)

Examples:

* `PremiumReputation` (paid IP/domain feeds)
* `DeepBehavioral` (heavier temporal analysis)
* `ClientFingerprint` (stable device IDs)
* `ContentHeuristic` (body-aware, PII-safe)
* `Llm` (AI-driven classification / cross-checks)

These detectors:

* Only run if the tenant has them licensed/enabled.
* Add extra `DetectorScore` entries:

    * e.g. `"name": "PremiumReputation", "score": 0.7`.

Your core logic just sees **a list of detectors**; licensing decides which ones run per tenant/edition.

---

## 6. Configuration & Policies

### 6.1. Free: File-based

* Located under a directory, e.g. `/etc/stylobot/` or `./config/`.

* Core files (examples):

    * `stylobot.settings.yaml` – service settings (ports, logging).
    * `policies/default.policy.yaml`
    * `signatures/*.yaml`
    * `detectors/*.yaml`

* Heavily commented; all tuning is **manual file edit + restart/reload**.

### 6.2. Enterprise: Same model + Admin APIs

* Same logical structure, but stored in:

    * a DB, or
    * a central config store.
* Admin APIs (gRPC) and UI read/write these:

    * adding tenant overrides,
    * enabling premium detectors,
    * adjusting bounded weights.

Export/import should map 1:1 with the file format:

```bash
stylobot export --tenant contoso > contoso.policy.yaml
stylobot import --tenant contoso contoso.policy.yaml
```

---

## 7. Live Stats & Ephemeral Integration

* Detection pipeline raises `DetectionCompleted` signals into Ephemeral.
* Ephemeral windows:

    * maintain bounded history of `DetectionResult` (plus minimal metadata).
    * drive:

        * SignalR updates,
        * periodic summaries (stats),
        * optional AI explanation jobs.

Typical pattern:

1. Detection completes.
2. `DetectionResult` → Ephemeral window.
3. Projectors:

    * update in-memory counters,
    * emit to SignalR at controlled interval,
    * enqueue optional `ExplainDetection` tasks for enterprise tenants.

---

## 8. Security & Multi-tenancy

* **API keys / tokens**:

    * REST: `X-Stylobot-Key` and/or bearer tokens.
    * gRPC: mTLS + tokens/JWT for tenant identification.
* **TenantId** is carried through:

    * requests,
    * decisions,
    * logs,
    * Ephemeral windows.
* **Rate limits**:

    * Per key/tenant,
    * Per edition:

        * Free has strict caps, heuristic-only.
        * Enterprise can have higher QPS and access to premium detectors.

---

## 9. Non-Goals / Constraints

* No remote SaaS enforcement is required; cloud aggregation is optional.
* No hidden detectors with secret weights; **all active detectors appear in `detectorScores`**.
* Auto-tuning ML of policies is out of scope for v1:

    * feedback is recorded,
    * human/manual decisions drive policy changes.

---

This should be enough to:

* drop into a repo as the “contract”,
* hang implementation details (YARP/Caddy/Traefik shims, SSH guards, dashboards) off it,
* and keep the Free vs Enterprise story clean: **same core, same scores; Enterprise just buys more detectors and more
  control.**
